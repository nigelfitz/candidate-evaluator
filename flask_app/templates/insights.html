{% extends "base.html" %}

{% block title %}Candidate Insights - Candidate Evaluator{% endblock %}

{% block content %}
<!-- Custom Confirmation Modal -->
<div id="unlockModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; backdrop-filter: blur(4px);">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 480px; width: 90%; overflow: hidden;">
        <!-- Header with gradient -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 32px 32px 24px; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 12px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));">üîì</div>
            <h3 style="color: white; margin: 0; font-weight: 700; font-size: 24px;">Unlock Insights?</h3>
        </div>
        
        <!-- Content -->
        <div style="padding: 32px;">
            <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="color: #64748b; font-size: 14px;">Current Balance</span>
                    <span id="modalCurrentBalance" style="color: #059669; font-weight: 700; font-size: 20px;">$24.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="color: #64748b; font-size: 14px;">Unlock Cost</span>
                    <span style="color: #dc2626; font-weight: 700; font-size: 20px;">- $1.00</span>
                </div>
                <div style="border-top: 2px solid #e2e8f0; margin: 12px 0; padding-top: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #1f2937; font-weight: 600;">New Balance</span>
                        <span id="modalNewBalance" style="color: #1f2937; font-weight: 700; font-size: 20px;">$23.00</span>
                    </div>
                </div>
            </div>
            
            <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <p style="margin: 0; color: #1e40af; font-size: 14px; line-height: 1.6;">
                    <strong>AI will generate for <span id="modalCandidateName">candidate</span>:</strong><br>
                    ‚úì Top Strengths matching the role<br>
                    ‚úì Gaps & Risk areas to consider<br>
                    ‚úì Overall Assessment & Recommendation
                </p>
            </div>
            
            <!-- Buttons -->
            <div style="display: flex; gap: 12px;">
                <button onclick="closeUnlockModal()" style="flex: 1; padding: 14px 24px; background: white; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; color: #64748b; cursor: pointer; transition: all 0.2s;">
                    Cancel
                </button>
                <button id="confirmUnlockBtn" onclick="confirmUnlock()" style="flex: 1; padding: 14px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); transition: all 0.2s;">
                    üîì Unlock Now
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt-4">
    {% if not has_insights %}
    <div class="alert alert-info">
        <h4>üìä Run Analysis First</h4>
        <p>Please complete an analysis to view candidate insights.</p>
        <a href="{{ url_for('analyze') }}" class="btn btn-primary">Go to Upload & Analyse</a>
    </div>
    {% else %}
    
    <!-- Workflow Stepper -->
    {% if is_current_draft_analysis %}
    {% set current_step = 5 %}
    {% include 'workflow_stepper.html' %}
    {% else %}
    <!-- Historical Analysis Header -->
    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="text-center">
            <h4 style="color: #1f2937; margin-bottom: 10px;">üí° Historical Candidate Insights</h4>
            <p class="text-muted mb-0">Viewing saved insights from a previous analysis</p>
            <div class="mt-3">
                <form method="POST" action="{{ url_for('load_analysis_to_draft', analysis_id=analysis_id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-warning btn-sm" 
                            onclick="return confirm('This will load this analysis into your draft workspace for editing and re-running. If you are in the middle of working on another job, that other job will be lost. After editing your historical job, you will need to \'Run Analysis\' on it, which will create a new job in your Job History list. Continue?');">
                        ‚úèÔ∏è Edit & Re-run This Analysis
                    </button>
                </form>
                <small class="text-muted ms-2">or <a href="{{ url_for('job_history') }}">Return to Job History</a> | <a href="{{ url_for('analyze', new=1) }}">Start New Analysis</a></small>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Quick Navigation Bar -->
    <div class="btn-group mb-3" role="group" style="box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <a href="{{ url_for('results', analysis_id=analysis_id) }}" class="btn btn-outline-primary">
            üìä Results
        </a>
        <a href="{{ url_for('exports', analysis_id=analysis_id) }}" class="btn btn-outline-primary">
            üìä Export Reports
        </a>
        <a href="{{ url_for('insights', analysis_id=analysis_id) }}" class="btn btn-primary">
            üí° Candidate Insights
        </a>
    </div>
    
    <!-- Candidate Selector and Navigation -->
    <div class="row mb-4">
        <div class="col-md-6">
            <label class="form-label fw-bold">Select Candidate</label>
            <select id="candidateSelect" class="form-select form-select-lg" onchange="selectCandidate(this.value)">
                {% for candidate in candidates %}
                <option value="{{ candidate.name }}" {% if candidate.name == current_candidate.name %}selected{% endif %}>
                    {{ candidate.name }} (Score: {{ "%.2f"|format(candidate.score) }}) ‚≠ê #{{ candidate.rank }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <label class="form-label fw-bold">Navigation & Download</label>
            <div class="btn-group w-100" role="group">
                <button class="btn btn-outline-primary" onclick="navigateCandidate(-1)" 
                        {% if current_idx == 0 %}disabled{% endif %}>
                    ‚¨ÖÔ∏è Previous
                </button>
                <button class="btn btn-outline-primary" onclick="navigateCandidate(1)"
                        {% if current_idx == candidates|length - 1 %}disabled{% endif %}>
                    Next ‚û°Ô∏è
                </button>
                <a href="{{ url_for('download_candidate_pdf', analysis_id=analysis_id, candidate_name=current_candidate.name) }}" 
                   class="btn btn-outline-success">
                    üì• PDF
                </a>
            </div>
        </div>
    </div>

    <!-- Candidate Header Card -->
    <div class="card mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="card-body">
            <h3 class="mb-3">üë§ {{ current_candidate.name }} ‚Äî At a Glance</h3>
            <div class="row">
                <div class="col-md-3">
                    <div class="text-center">
                        <div style="font-size: 0.9rem; opacity: 0.9;">Overall Score</div>
                        <div style="font-size: 2.5rem; font-weight: bold;">{{ "%.2f"|format(current_candidate.score) }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div style="font-size: 0.9rem; opacity: 0.9;">Rank</div>
                        <div style="font-size: 2.5rem; font-weight: bold;">#{{ current_candidate.rank }}</div>
                        <div style="font-size: 0.85rem; opacity: 0.8;">of {{ candidates|length }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="text-center">
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">Criteria Breakdown</div>
                        <div style="font-size: 1.5rem;">
                            <span class="badge bg-success me-2">‚úÖ {{ current_candidate.strong_count }} Strong</span>
                            <span class="badge bg-warning text-dark me-2">‚ö†Ô∏è {{ current_candidate.moderate_count }} Moderate</span>
                            <span class="badge bg-danger">‚õî {{ current_candidate.weak_count }} Weak</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- File Viewing Sections -->
    {% if current_candidate.file %}
    <!-- View Original PDF File -->
    {% if current_candidate.file.file_name.lower().endswith('.pdf') %}
    <div class="card mb-4">
        <div class="card-body">
            <details>
                <summary style="cursor: pointer; color: #1f77b4; font-size: 1.1rem; font-weight: 500;">
                    üìÑ View Original PDF File
                </summary>
                <div class="mt-2">
                    <iframe 
                        src="{{ url_for('view_candidate_file', analysis_id=analysis_id, candidate_name=current_candidate.name) }}" 
                        width="100%" 
                        height="600px" 
                        style="border: 1px solid #ddd; border-radius: 4px;">
                    </iframe>
                    <div class="mt-2">
                        <a href="{{ url_for('view_candidate_file', analysis_id=analysis_id, candidate_name=current_candidate.name) }}" 
                           target="_blank" 
                           class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i> Open in New Tab
                        </a>
                    </div>
                </div>
            </details>
        </div>
    </div>
    {% endif %}

    <!-- Full Text Extract -->
    <div class="card mb-4">
        <div class="card-body">
            <details>
                <summary style="cursor: pointer; color: #1f77b4; font-size: 1.1rem; font-weight: 500;">
                    üìÑ Full Text Extract - used for AI/GPT analysis
                </summary>
                <div class="mt-2">
                    <textarea 
                        readonly 
                        class="form-control" 
                        style="width: 100%; height: 300px; font-family: 'Courier New', monospace; font-size: 0.9rem; resize: vertical;">{{ current_candidate.file.extracted_text }}</textarea>
                    <small class="text-muted d-block mt-2">
                        üìä {{ current_candidate.file.extracted_text|length|number_format }} characters extracted
                        {% if current_candidate.file.file_name.lower().endswith('.pdf') %}
                        | Method: Layout-aware (PyMuPDF)
                        {% elif current_candidate.file.file_name.lower().endswith('.docx') %}
                        | Method: DOCX parser
                        {% else %}
                        | Method: Direct text
                        {% endif %}
                    </small>
                </div>
            </details>
        </div>
    </div>
    {% endif %}
    <!-- GPT Insights Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">üí° AI-Powered Insights</h4>
        </div>
        <div class="card-body">
            {% if current_candidate.has_gpt_insights %}
                <!-- Top Strengths -->
                <h5 class="text-success mb-3">‚úÖ Top Strengths</h5>
                {% if current_candidate.insights.top %}
                <ul class="list-group mb-4">
                    {% for strength in current_candidate.insights.top %}
                    <li class="list-group-item">{{ strength }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No specific strengths identified.</p>
                {% endif %}
                
                <!-- Gaps & Risks -->
                <h5 class="text-danger mb-3">‚ö†Ô∏è Gaps & Risks</h5>
                {% if current_candidate.insights.gaps %}
                <ul class="list-group mb-4">
                    {% for gap in current_candidate.insights.gaps %}
                    <li class="list-group-item">{{ gap }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No specific gaps identified.</p>
                {% endif %}
                
                <!-- Overall Assessment -->
                <h5 class="text-info mb-3">üìù Overall Assessment</h5>
                {% if current_candidate.insights.notes %}
                <div class="alert alert-light">{{ current_candidate.insights.notes }}</div>
                {% else %}
                <p class="text-muted">No overall assessment available.</p>
                {% endif %}
            {% elif current_candidate.rank > 5 and not has_full_radar %}
            <!-- Locked State for Rank 6+ without Full Radar -->
            <div style="position: relative;" class="unlock-overlay">
                <!-- Blurred Content -->
                <div style="filter: blur(8px); pointer-events: none; user-select: none; opacity: 0.4;">
                    <h5 class="text-success mb-3">‚úÖ Top Strengths</h5>
                    <ul class="list-group mb-4">
                        <li class="list-group-item">Lorem ipsum dolor sit amet consectetur adipisicing elit</li>
                        <li class="list-group-item">Sed do eiusmod tempor incididunt ut labore et dolore magna</li>
                        <li class="list-group-item">Ut enim ad minim veniam quis nostrud exercitation ullamco</li>
                    </ul>
                    <h5 class="text-danger mb-3">‚ö†Ô∏è Gaps & Risks</h5>
                    <ul class="list-group mb-4">
                        <li class="list-group-item">Duis aute irure dolor in reprehenderit in voluptate velit</li>
                        <li class="list-group-item">Excepteur sint occaecat cupidatat non proident sunt in culpa</li>
                    </ul>
                </div>
                
                <!-- Unlock Overlay -->
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: white; padding: 32px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); max-width: 400px; width: 90%;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üîí</div>
                    <h4 style="color: #1f2937; margin-bottom: 12px; font-weight: 700;">Deep Insights Locked</h4>
                    <p style="color: #64748b; margin-bottom: 24px; font-size: 15px;">This candidate ranked #{{ current_candidate.rank }}. Detailed AI summaries are available for Top 5 candidates only.</p>
                    <button onclick="unlockCandidate({{ analysis_id }}, '{{ current_candidate.name }}', {{ '%.2f' % current_user.balance_usd }})" class="btn btn-lg unlock-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 32px; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                        üîì Unlock Deep Insight - $1.00
                    </button>
                    <p style="margin-top: 16px; font-size: 13px; color: #94a3b8;">Or upgrade to Full Radar to unlock all candidates</p>
                </div>
            </div>
            {% else %}
                <div class="alert alert-warning">
                    <h5>‚ö†Ô∏è GPT Insights Not Generated</h5>
                    <p>This candidate was scored but didn't receive detailed AI analysis. This happens when:</p>
                    <ul>
                        <li>You selected "Top N" and this candidate wasn't in the top group</li>
                        <li>You used custom selection and didn't include this candidate</li>
                        <li>You chose "None" for AI insights</li>
                    </ul>
                    <p class="mb-0"><strong>To generate insights:</strong> Re-run analysis with this candidate included in the insights selection.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Detailed Scores by Category -->
    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0">üìä Detailed Scores by Category</h4>
        </div>
        <div class="card-body">
            {% for category, criteria_list in current_candidate.scores_by_category.items() %}
            <div class="mb-4">
                <h5 class="mb-3">{{ category }}</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60%;">Criterion</th>
                                <th style="width: 15%; text-align: center;">Score</th>
                                <th style="width: 25%; text-align: center;">Rating</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in criteria_list %}
                            <tr>
                                <td>{{ item.criterion }}</td>
                                <td style="text-align: center;">
                                    <span style="font-weight: bold; color: {{ item.color }};">{{ "%.2f"|format(item.score) }}</span>
                                </td>
                                <td style="text-align: center;">
                                    <span class="badge" style="background-color: {{ item.color }};">{{ item.rating }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Evidence Snippets -->
    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0">üîç Evidence from Resume</h4>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">Top evidence snippets for each criterion (best matches)</p>
            <div class="accordion" id="evidenceAccordion">
                {% for item in current_candidate.evidence %}
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#evidence{{ loop.index }}">
                            {{ item.criterion }} 
                            <span class="badge ms-2" style="background-color: {{ item.color }};">{{ "%.2f"|format(item.score) }}</span>
                        </button>
                    </h2>
                    <div id="evidence{{ loop.index }}" class="accordion-collapse collapse" 
                         data-bs-parent="#evidenceAccordion">
                        <div class="accordion-body">
                            <pre style="background: #f8f9fa; padding: 1rem; border-radius: 4px; white-space: pre-wrap;">{{ item.snippet }}</pre>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% endif %}
</div>

<script>
// Global variables for unlock flow
let unlockAnalysisId, unlockCandidateName, unlockUserBalance;

function selectCandidate(candidateName) {
    window.location.href = `{{ url_for('insights', analysis_id=analysis_id) }}?candidate=${encodeURIComponent(candidateName)}`;
}

function navigateCandidate(direction) {
    const select = document.getElementById('candidateSelect');
    const newIndex = select.selectedIndex + direction;
    if (newIndex >= 0 && newIndex < select.options.length) {
        select.selectedIndex = newIndex;
        selectCandidate(select.options[newIndex].value);
    }
}

// Show custom unlock modal
function unlockCandidate(analysisId, candidateName, userBalance) {
    // Convert balance to number and check
    userBalance = parseFloat(userBalance);
    
    if (userBalance < 1.00) {
        // Redirect to top-up page
        window.location.href = "{{ url_for('payments.buy_credits') }}";
        return;
    }
    
    // Store data for later use
    unlockAnalysisId = analysisId;
    unlockCandidateName = candidateName;
    unlockUserBalance = parseFloat(userBalance); // Convert to number
    
    // Update modal content
    document.getElementById('modalCurrentBalance').textContent = `$${unlockUserBalance.toFixed(2)}`;
    document.getElementById('modalNewBalance').textContent = `$${(unlockUserBalance - 1.00).toFixed(2)}`;
    document.getElementById('modalCandidateName').textContent = candidateName;
    
    // Show modal with animation
    const modal = document.getElementById('unlockModal');
    modal.style.display = 'block';
    modal.style.opacity = '0';
    setTimeout(() => {
        modal.style.transition = 'opacity 0.3s ease';
        modal.style.opacity = '1';
    }, 10);
}

// Close modal
function closeUnlockModal() {
    const modal = document.getElementById('unlockModal');
    modal.style.opacity = '0';
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

// Confirm unlock and proceed
function confirmUnlock() {
    // Find the unlock button and show loading state
    const confirmBtn = document.getElementById('confirmUnlockBtn');
    const originalText = confirmBtn.innerHTML;
    
    confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
    confirmBtn.disabled = true;
    
    // Make AJAX request to unlock
    fetch(`/unlock-candidate/${unlockAnalysisId}/${encodeURIComponent(unlockCandidateName)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update balance in header
            const balanceEl = document.querySelector('.balance-amount');
            if (balanceEl) {
                balanceEl.textContent = `$${data.new_balance.toFixed(2)}`;
            }
            
            // Show success message in modal
            confirmBtn.innerHTML = '‚úì Success! Reloading...';
            confirmBtn.style.background = '#10b981';
            
            // Reload the page to show new insights (maintains scroll position)
            const scrollPos = window.scrollY;
            sessionStorage.setItem('scrollPosition', scrollPos);
            setTimeout(() => {
                window.location.reload();
            }, 800);
        } else if (data.error === 'Insufficient balance') {
            closeUnlockModal();
            alert('Insufficient balance. Redirecting to top-up page...');
            window.location.href = data.redirect;
        } else {
            closeUnlockModal();
            alert(`Error: ${data.error}\n\nPlease check the browser console for details or try again.`);
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error unlocking candidate:', error);
        closeUnlockModal();
        alert('Failed to unlock insights. Please try again.\n\nMake sure Flask server is running and check browser console for details.');
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('unlockModal');
    if (e.target === modal) {
        closeUnlockModal();
    }
});

// Restore scroll position after reload
window.addEventListener('load', function() {
    const scrollPos = sessionStorage.getItem('scrollPosition');
    if (scrollPos) {
        window.scrollTo(0, parseInt(scrollPos));
        sessionStorage.removeItem('scrollPosition');
    }
});
</script>

<!-- Sticky Bottom Bar -->
{% if is_current_draft_analysis %}
{% set show_back_button = True %}
{% set back_url = url_for('results', analysis_id=analysis_id) %}
{% set continue_text = 'Start New Analysis' %}
{% set continue_url = url_for('analyze', new=1) %}
{% set continue_disabled = false %}
{% include 'workflow_bottom_bar.html' %}
{% endif %}
{% endblock %}
