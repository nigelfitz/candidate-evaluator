{% extends "base.html" %}

{% block title %}Candidate Insights - Candidate Evaluator{% endblock %}

{% block extra_css %}
<style>
    /* Frosted Glass Effect for Locked Insights */
    .insights-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .unlock-overlay-container {
        position: relative;
        min-height: 400px;
        border-radius: 16px;
        overflow: hidden;
    }
    
    .blurred-insights {
        filter: blur(12px) saturate(120%);
        pointer-events: none;
        user-select: none;
        opacity: 0.3;
        padding: 24px;
    }
    
    .frosted-glass-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(255,255,255,0.85) 0%, rgba(248,250,252,0.9) 100%);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    
    .unlock-card {
        background: white;
        padding: 48px 40px;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        text-align: center;
        max-width: 480px;
        width: 90%;
        border: 1px solid rgba(255,255,255,0.5);
    }
    
    .lock-icon {
        font-size: 72px;
        margin-bottom: 20px;
        filter: drop-shadow(0 8px 16px rgba(212,175,55,0.3));
    }
    
    .unlock-btn-primary {
        background: linear-gradient(135deg, #d4af37 0%, #f4d03f 50%, #d4af37 100%);
        border: none;
        color: #1f2937;
        padding: 16px 36px;
        font-weight: 700;
        font-size: 16px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(212,175,55,0.4);
        transition: all 0.3s ease;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .unlock-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(212,175,55,0.5);
        background: linear-gradient(135deg, #f4d03f 0%, #d4af37 50%, #f4d03f 100%);
    }
    
    .balance-display {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #f0fdf4;
        color: #15803d;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
        margin-top: 16px;
        border: 1px solid #bbf7d0;
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        /* Navigation bar stays horizontal but wraps if needed */
        .btn-group {
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn-group .btn {
            flex: 0 1 auto;
            font-size: 14px;
            padding: 8px 12px;
        }
        
        /* Slim Executive Summary on Mobile */
        .card-body .row.align-items-center {
            flex-direction: column;
            text-align: center;
        }
        
        .card-body .row.align-items-center .col-md-8,
        .card-body .row.align-items-center .col-md-4 {
            width: 100%;
            text-align: center !important;
            margin-bottom: 12px;
        }
        
        /* Keep Prev/Next buttons on same line even on mobile */
        .col-md-4 > div {
            justify-content: center !important;
        }
        
        /* Adjust score badges */
        .badge {
            font-size: 12px;
            padding: 4px 8px;
        }
        
        /* Ensure text doesn't overflow */
        h3 {
            font-size: 1.5rem;
            word-wrap: break-word;
        }
        
        .text-muted.small {
            font-size: 0.85rem;
            line-height: 1.4;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Custom Confirmation Modal -->
<div id="unlockModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; backdrop-filter: blur(4px);">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 480px; width: 90%; overflow: hidden;">
        <!-- Header with gradient -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 32px 32px 24px; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 12px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));">üîì</div>
            <h3 style="color: white; margin: 0; font-weight: 700; font-size: 24px;">Unlock Insights?</h3>
        </div>
        
        <!-- Content -->
        <div style="padding: 32px;">
            <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="color: #64748b; font-size: 14px;">Current Balance</span>
                    <span id="modalCurrentBalance" style="color: #059669; font-weight: 700; font-size: 20px;">$24.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="color: #64748b; font-size: 14px;">Unlock Cost</span>
                    <span style="color: #dc2626; font-weight: 700; font-size: 20px;">- $1.00</span>
                </div>
                <div style="border-top: 2px solid #e2e8f0; margin: 12px 0; padding-top: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #1f2937; font-weight: 600;">New Balance</span>
                        <span id="modalNewBalance" style="color: #1f2937; font-weight: 700; font-size: 20px;">$23.00</span>
                    </div>
                </div>
            </div>
            
            <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <p style="margin: 0; color: #1e40af; font-size: 14px; line-height: 1.6;">
                    <strong>AI will generate for <span id="modalCandidateName">candidate</span>:</strong><br>
                    ‚úì Top Strengths matching the role<br>
                    ‚úì Gaps & Risk areas to consider<br>
                    ‚úì Overall Assessment & Recommendation
                </p>
            </div>
            
            <!-- Buttons -->
            <div style="display: flex; gap: 12px;">
                <button onclick="closeUnlockModal()" style="flex: 1; padding: 14px 24px; background: white; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; color: #64748b; cursor: pointer; transition: all 0.2s;">
                    Cancel
                </button>
                <button id="confirmUnlockBtn" onclick="confirmUnlock()" style="flex: 1; padding: 14px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); transition: all 0.2s;">
                    üîì Unlock Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Side Drawer for Evidence -->
<div id="evidenceDrawer" style="position: fixed; top: 0; right: -600px; width: 600px; height: 100vh; background: white; box-shadow: -4px 0 24px rgba(0,0,0,0.15); z-index: 10000; transition: right 0.3s ease; overflow-y: auto;">
    <!-- Drawer Header -->
    <div style="position: sticky; top: 0; background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%); padding: 24px; border-bottom: 2px solid #e5e7eb; z-index: 10;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h4 id="drawerTitle" style="color: white; margin: 0; font-weight: 700; font-size: 20px;">Evidence</h4>
                <p style="color: rgba(255,255,255,0.9); margin: 4px 0 0 0; font-size: 13px;">Raw text extracted from resume</p>
            </div>
            <button onclick="closeEvidenceDrawer()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <i data-lucide="x" style="width: 20px; height: 20px;"></i>
            </button>
        </div>
    </div>
    
    <!-- Drawer Content -->
    <div style="padding: 24px;">
        <pre id="drawerContent" style="background: #f8fafc; padding: 20px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; font-size: 14px; border: 1px solid #e5e7eb; font-family: 'Courier New', monospace; color: #1f2937;"></pre>
    </div>
</div>

<!-- Drawer Overlay -->
<div id="drawerOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.5); z-index: 9999; display: none; opacity: 0; transition: opacity 0.3s ease;" onclick="closeEvidenceDrawer()"></div>

<div class="container-fluid mt-4">
    {% if not has_insights %}
    <div class="alert alert-info">
        <h4>üìä Run Analysis First</h4>
        <p>Please complete an analysis to view candidate insights.</p>
        <a href="{{ url_for('analyze') }}" class="btn btn-primary">Go to Upload & Analyse</a>
    </div>
    {% else %}
    
    <!-- Workflow Stepper -->
    {% if is_current_draft_analysis %}
    {% set current_step = 5 %}
    {% include 'workflow_stepper.html' %}
    {% else %}
    <!-- Historical Analysis Header -->
    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="text-center">
            <h4 style="color: #1f2937; margin-bottom: 10px;">üí° Historical Candidate Insights</h4>
            <p class="text-muted mb-0">Viewing saved insights from a previous analysis</p>
            <div class="mt-3">
                <form method="POST" action="{{ url_for('load_analysis_to_draft', analysis_id=analysis_id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-warning btn-sm" 
                            onclick="return confirm('This will load this analysis into your draft workspace for editing and re-running. If you are in the middle of working on another job, that other job will be lost. After editing your historical job, you will need to \'Run Analysis\' on it, which will create a new job in your Job History list. Continue?');">
                        ‚úèÔ∏è Edit & Re-run This Analysis
                    </button>
                </form>
                <small class="text-muted ms-2">or <a href="{{ url_for('job_history') }}">Return to Job History</a> | <a href="{{ url_for('analyze', new=1) }}">Start New Analysis</a></small>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Unified Navigation Bar -->
    <div class="btn-group mb-3" role="group" style="box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: row;">
        <a href="{{ url_for('results', analysis_id=analysis_id) }}" class="btn btn-outline-primary" style="display: flex; align-items: center; gap: 8px; flex: 0 0 auto;">
            <i data-lucide="grid-3x3" style="width: 18px; height: 18px;"></i>
            Results
        </a>
        <a href="{{ url_for('insights', analysis_id=analysis_id) }}" class="btn btn-primary" style="display: flex; align-items: center; gap: 8px; flex: 0 0 auto;">
            <i data-lucide="lightbulb" style="width: 18px; height: 18px;"></i>
            Candidate Insights
        </a>
        <a href="{{ url_for('exports', analysis_id=analysis_id) }}" class="btn btn-outline-primary" style="display: flex; align-items: center; gap: 8px; flex: 0 0 auto;">
            <i data-lucide="file-text" style="width: 18px; height: 18px;"></i>
            Export Reports
        </a>
    </div>
    
    <!-- Unified Metadata Bar -->
    <div class="card mb-4" style="background: white; border-left: 4px solid #3b82f6;">
        <div class="card-body py-2">
            <p class="mb-0" style="font-size: 15px; color: #6b7280;">
                <strong style="color: #1f2937;">Job Title:</strong> {{ analysis.job_title if analysis.job_title else 'N/A' }} | 
                <strong style="color: #1f2937;">Analyzed:</strong> {{ analysis.created_at.strftime('%B %d, %Y') if analysis.created_at else 'N/A' }} | 
                <strong style="color: #1f2937;">{{ candidates|length }}</strong> Candidates | 
                <strong style="color: #1f2937;">{{ current_candidate.evidence|length }}</strong> Criteria
            </p>
        </div>
    </div>
    
    <!-- Insights Content Container -->
    <div class="insights-container">

    <!-- Slim Executive Summary Header -->
    <div class="card mb-4" style="background: white; border-left: 4px solid #3b82f6;">
        <div class="card-body py-3">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h3 class="mb-1" style="color: #1f2937; font-weight: 700; font-size: 1.75rem;">üë§ {{ current_candidate.name }}</h3>
                    <div class="text-muted small">
                        <span class="me-3"><strong>Overall Score:</strong> {{ (current_candidate.score * 100)|int }}%</span>
                        <span class="me-3"><strong>Rank:</strong> #{{ current_candidate.rank }} of {{ candidates|length }}</span>
                        <span class="badge bg-success me-1">‚úÖ {{ current_candidate.strong_count }}</span>
                        <span class="badge bg-warning text-dark me-1">‚ö†Ô∏è {{ current_candidate.moderate_count }}</span>
                        <span class="badge bg-danger">‚õî {{ current_candidate.weak_count }}</span>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <!-- Elegant Chevron Navigation on Same Line with 10px gap -->
                    <div style="display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn btn-sm btn-outline-secondary" onclick="navigateCandidate(-1)" 
                                {% if current_idx == 0 %}disabled{% endif %}
                                style="display: flex; align-items: center; gap: 6px; padding: 8px 16px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                            Prev
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="navigateCandidate(1)"
                                {% if current_idx == candidates|length - 1 %}disabled{% endif %}
                                style="display: flex; align-items: center; gap: 6px; padding: 8px 16px;">
                            Next
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- GPT Insights Section -->
    <div class="card mb-4" style="border: 2px solid #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);">
        <div class="card-header text-white" style="background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%); padding: 20px;">
            <h4 class="mb-0" style="display: flex; align-items: center; font-weight: 700;">
                <i data-lucide="sparkles" style="width: 24px; height: 24px; margin-right: 10px;"></i>
                Deep AI Insights
            </h4>
            <p class="mb-0 mt-1" style="font-size: 13px; opacity: 0.95;">AI-powered analysis of strengths, gaps, and recommendations</p>
        </div>
        <div class="card-body" style="padding: 28px;">
            {% if current_candidate.has_gpt_insights %}
                <!-- Top Strengths -->
                <h5 class="text-success mb-3">‚úÖ Top Strengths</h5>
                {% if current_candidate.insights.top %}
                <ul class="list-unstyled mb-4" style="list-style-type: none; padding-left: 0; margin-left: 0;">
                    {% for strength in current_candidate.insights.top %}
                    <li class="mb-2" style="border-left: 3px solid #10b981; padding-left: 16px; margin-left: 0;">‚Ä¢ {{ strength }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No specific strengths identified.</p>
                {% endif %}
                
                <!-- Gaps & Risks -->
                <h5 class="text-danger mb-3">‚ö†Ô∏è Gaps & Risks</h5>
                {% if current_candidate.insights.gaps %}
                <ul class="list-unstyled mb-4" style="list-style-type: none; padding-left: 0; margin-left: 0;">
                    {% for gap in current_candidate.insights.gaps %}
                    <li class="mb-2" style="border-left: 3px solid #ef4444; padding-left: 16px; margin-left: 0;">‚Ä¢ {{ gap }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No specific gaps identified.</p>
                {% endif %}
                
                <!-- Overall Assessment -->
                <h5 class="text-info mb-3">üìù Overall Assessment</h5>
                {% if current_candidate.insights.notes %}
                <div class="alert alert-light">{{ current_candidate.insights.notes }}</div>
                {% else %}
                <p class="text-muted">No overall assessment available.</p>
                {% endif %}
            {% elif current_candidate.rank > 5 and not has_full_radar %}
            <!-- Locked State for Rank 6+ without Full Radar -->
            <div class="unlock-overlay-container">
                <!-- Blurred Content with Frosted Glass -->
                <div class="blurred-insights">
                    <h5 class="text-success mb-3">‚úÖ Top Strengths</h5>
                    <ul class="list-group mb-4">
                        <li class="list-group-item">Lorem ipsum dolor sit amet consectetur adipisicing elit</li>
                        <li class="list-group-item">Sed do eiusmod tempor incididunt ut labore et dolore magna</li>
                        <li class="list-group-item">Ut enim ad minim veniam quis nostrud exercitation ullamco</li>
                    </ul>
                    <h5 class="text-danger mb-3">‚ö†Ô∏è Gaps & Risks</h5>
                    <ul class="list-group mb-4">
                        <li class="list-group-item">Duis aute irure dolor in reprehenderit in voluptate velit</li>
                        <li class="list-group-item">Excepteur sint occaecat cupidatat non proident sunt in culpa</li>
                    </ul>
                </div>
                
                <!-- Frosted Glass Overlay with Gold Lock -->
                <div class="frosted-glass-overlay">
                    <div class="unlock-card">
                        <div class="lock-icon">üîê</div>
                        <h3 style="color: #1f2937; margin-bottom: 12px; font-weight: 700; font-size: 28px;">Deep Insights Locked</h3>
                        <p style="color: #64748b; margin-bottom: 28px; font-size: 16px; line-height: 1.6;">
                            This candidate ranked <strong>#{{ current_candidate.rank }}</strong>. 
                            Unlock AI-generated strengths, gaps, and recommendations for just <strong>$1.00</strong>.
                        </p>
                        <button onclick="unlockCandidate({{ analysis_id }}, '{{ current_candidate.name }}', {{ '%.2f' % current_user.balance_usd }})" class="unlock-btn-primary">
                            üîì Unlock Deep Insight ($1.00)
                        </button>
                        <div class="balance-display">
                            üí∞ Your Balance: ${{ "%.2f"|format(current_user.balance_usd) }}
                        </div>
                        <p style="margin-top: 20px; font-size: 13px; color: #94a3b8;">
                            <a href="{{ url_for('account') }}" style="color: #3b82f6; text-decoration: none;">Top up balance</a> if needed
                        </p>
                    </div>
                </div>
            </div>
            {% else %}
                <div class="alert alert-warning">
                    <h5>‚ö†Ô∏è GPT Insights Not Generated</h5>
                    <p>This candidate was scored but didn't receive detailed AI analysis. This happens when:</p>
                    <ul>
                        <li>You selected "Top N" and this candidate wasn't in the top group</li>
                        <li>You used custom selection and didn't include this candidate</li>
                        <li>You chose "None" for AI insights</li>
                    </ul>
                    <p class="mb-0"><strong>To generate insights:</strong> Re-run analysis with this candidate included in the insights selection.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Detailed Scores by Category -->
    <div class="card mb-4">
        <div class="card-header" style="background: #f8fafc; border-bottom: 2px solid #e5e7eb;">
            <h4 class="mb-0" style="color: #475569;">üìä Detailed Scores by Category</h4>
            <p class="text-muted mb-0 mt-1" style="font-size: 13px;">Objective scoring across all evaluation criteria</p>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60%;">Criterion</th>
                            <th style="width: 15%; text-align: center;">Score</th>
                            <th style="width: 25%; text-align: center;">Rating</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category, criteria_list in current_candidate.scores_by_category.items() %}
                        <!-- Category separator row -->
                        <tr>
                            <td colspan="3" style="background-color: #f8f9fa; padding: 12px 16px; border-top: 2px solid #dee2e6; border-bottom: 1px solid #dee2e6;">
                                <strong style="font-size: 16px; color: #1f2937;">{{ category|replace('_', ' ')|title }}</strong>
                            </td>
                        </tr>
                        <!-- Criteria rows for this category -->
                        {% for item in criteria_list %}
                        <tr>
                            <td>{{ item.criterion }}</td>
                            <td style="text-align: center;">
                                <span style="font-weight: bold; color: {{ item.color }}">{{ (item.score * 100)|int }}%</span>
                            </td>
                            <td style="text-align: center;">
                                {% if item.rating in ['Poor', 'Weak'] %}
                                <span class="badge" style="background-color: {{ item.color }}; color: white; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">{{ item.rating }}</span>
                                {% else %}
                                <span class="badge" style="background-color: {{ item.color }}; color: #1f2937; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">{{ item.rating }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Evidence Links (Side Drawer Triggers) -->
    <div class="card mb-4">
        <div class="card-header" style="background: #f8fafc;">
            <h4 class="mb-0" style="color: #475569;">üîç Evidence from Resume</h4>
            <p class="text-muted mb-0 mt-1" style="font-size: 13px;">View raw text extracted from resume for each criterion</p>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60%;">Criterion</th>
                            <th style="width: 15%; text-align: center;">Score</th>
                            <th style="width: 25%; text-align: center;">View Evidence</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in current_candidate.evidence %}
                        <tr>
                            <td>{{ item.criterion }}</td>
                            <td style="text-align: center;">
                                {% if item.rating in ['Poor', 'Weak'] %}
                                <span class="badge" style="background-color: {{ item.color }}; color: white; padding: 4px 10px; border-radius: 10px; font-size: 11px;">{{ (item.score * 100)|int }}%</span>
                                {% else %}
                                <span class="badge" style="background-color: {{ item.color }}; color: #1f2937; padding: 4px 10px; border-radius: 10px; font-size: 11px;">{{ (item.score * 100)|int }}%</span>
                                {% endif %}
                            </td>
                            <td style="text-align: center;">
                                <button class="btn btn-sm btn-outline-primary" onclick="openEvidenceDrawer('{{ item.criterion|e }}', `{{ item.snippet|e }}`)"
                                        style="padding: 4px 12px; font-size: 13px; border-radius: 6px;">
                                    <i data-lucide="eye" style="width: 14px; height: 14px; margin-right: 4px;"></i>
                                    View Source
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Supporting Documents - Grouped Accordions -->
    {% if current_candidate.file %}
    <div class="card mb-4">
        <div class="card-header" style="background: #f8fafc; border-bottom: 2px solid #e5e7eb;">
            <h5 class="mb-0" style="color: #64748b; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">üìÅ Supporting Documents</h5>
        </div>
        <div class="card-body p-0">
            <div class="accordion" id="documentsAccordion">
                <!-- Primary Resume Group -->
                <div class="accordion-item border-0">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#primaryResumeGroup"
                                style="background: #f8fafc; padding: 16px 20px; border-bottom: 1px solid #e5e7eb; font-weight: 700; color: #1f2937;">
                            <i data-lucide="file-check" style="width: 20px; height: 20px; margin-right: 10px; color: #3b82f6;"></i>
                            <span>Primary Resume</span>
                            <span class="badge bg-primary ms-2" style="font-size: 11px; padding: 4px 8px;">{{ current_candidate.file.file_name }}</span>
                        </button>
                    </h2>
                    <div id="primaryResumeGroup" class="accordion-collapse collapse" data-bs-parent="#documentsAccordion">
                        <div class="accordion-body p-0">
                            <!-- Nested accordion for primary resume items -->
                            <div class="accordion" id="primaryResumeItems">
                                {% if current_candidate.file.file_name.lower().endswith('.pdf') %}
                                <!-- View Original PDF -->
                                <div class="accordion-item border-0">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pdfViewer"
                                                style="background: white; padding: 14px 20px 14px 40px; border-bottom: 1px solid #e5e7eb;">
                                            <i data-lucide="file-text" style="width: 16px; height: 16px; margin-right: 8px; color: #64748b;"></i>
                                            <span style="font-weight: 600; color: #475569; font-size: 14px;">View Original PDF</span>
                                        </button>
                                    </h2>
                                    <div id="pdfViewer" class="accordion-collapse collapse" data-bs-parent="#primaryResumeItems">
                                        <div class="accordion-body" style="background: #f8fafc; padding: 20px;">
                                            <iframe 
                                                src="{{ url_for('view_candidate_file', analysis_id=analysis_id, candidate_name=current_candidate.name) }}" 
                                                width="100%" 
                                                height="600px" 
                                                style="border: 2px solid #e5e7eb; border-radius: 8px; background: white;">
                                            </iframe>
                                            <div class="mt-3">
                                                <a href="{{ url_for('view_candidate_file', analysis_id=analysis_id, candidate_name=current_candidate.name) }}" 
                                                   target="_blank" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i data-lucide="external-link" style="width: 14px; height: 14px; margin-right: 6px;"></i> Open in New Tab
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                <!-- Full Text Extract -->
                                <div class="accordion-item border-0">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#textExtract"
                                                style="background: white; padding: 14px 20px 14px 40px;">
                                            <i data-lucide="align-left" style="width: 16px; height: 16px; margin-right: 8px; color: #64748b;"></i>
                                            <span style="font-weight: 600; color: #475569; font-size: 14px;">Full Text Extract (AI Input)</span>
                                            <span class="badge bg-info ms-2" style="font-size: 10px; padding: 3px 6px;">{{ current_candidate.file.extracted_text|length|number_format }} chars</span>
                                        </button>
                                    </h2>
                                    <div id="textExtract" class="accordion-collapse collapse" data-bs-parent="#primaryResumeItems">
                                        <div class="accordion-body" style="background: #f8fafc; padding: 20px;">
                                            <textarea 
                                                readonly 
                                                class="form-control" 
                                                style="width: 100%; height: 300px; font-family: 'Courier New', monospace; font-size: 0.9rem; resize: vertical; background: white; border: 2px solid #e5e7eb;">{{ current_candidate.file.extracted_text }}</textarea>
                                            <small class="text-muted d-block mt-2">
                                                <i data-lucide="info" style="width: 14px; height: 14px; margin-right: 4px;"></i>
                                                üìä {{ current_candidate.file.extracted_text|length|number_format }} characters extracted
                                                {% if current_candidate.file.file_name.lower().endswith('.pdf') %}
                                                | Method: Layout-aware (PyMuPDF)
                                                {% elif current_candidate.file.file_name.lower().endswith('.docx') %}
                                                | Method: DOCX parser
                                                {% else %}
                                                | Method: Direct text
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Files Group (Placeholder for future expansion) -->
                <div class="accordion-item border-0">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#additionalFilesGroup" disabled
                                style="background: white; padding: 16px 20px; opacity: 0.6; cursor: not-allowed;">
                            <i data-lucide="folder-plus" style="width: 20px; height: 20px; margin-right: 10px; color: #94a3b8;"></i>
                            <span style="font-weight: 600; color: #64748b;">Additional Files</span>
                            <span class="badge bg-secondary ms-2" style="font-size: 11px; padding: 4px 8px;">Coming Soon</span>
                        </button>
                    </h2>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% endif %}
    </div><!-- Close insights-container -->
</div>

<script>
// Side Drawer Functions
function openEvidenceDrawer(criterion, snippet) {
    const drawer = document.getElementById('evidenceDrawer');
    const overlay = document.getElementById('drawerOverlay');
    const title = document.getElementById('drawerTitle');
    const content = document.getElementById('drawerContent');
    
    // Set content
    title.textContent = criterion;
    content.textContent = snippet;
    
    // Show overlay
    overlay.style.display = 'block';
    setTimeout(() => {
        overlay.style.opacity = '1';
    }, 10);
    
    // Slide in drawer
    setTimeout(() => {
        drawer.style.right = '0';
    }, 10);
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
    
    // Re-initialize Lucide icons for the close button
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function closeEvidenceDrawer() {
    const drawer = document.getElementById('evidenceDrawer');
    const overlay = document.getElementById('drawerOverlay');
    
    // Slide out drawer
    drawer.style.right = '-600px';
    
    // Fade out overlay
    overlay.style.opacity = '0';
    
    // Hide overlay after transition
    setTimeout(() => {
        overlay.style.display = 'none';
    }, 300);
    
    // Restore body scroll
    document.body.style.overflow = 'auto';
}

// Close drawer with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEvidenceDrawer();
    }
});

// Global variables for unlock flow
let unlockAnalysisId, unlockCandidateName, unlockUserBalance;

// Candidate list from Flask
const candidates = {{ candidates | tojson | safe }};
const currentCandidateName = "{{ current_candidate.name }}";
const currentIdx = candidates.findIndex(c => c.name === currentCandidateName);

function navigateCandidate(direction) {
    const newIndex = currentIdx + direction;
    if (newIndex >= 0 && newIndex < candidates.length) {
        const nextCandidate = candidates[newIndex];
        window.location.href = `{{ url_for('insights', analysis_id=analysis_id) }}?candidate=${encodeURIComponent(nextCandidate.name)}`;
    }
}

// Show custom unlock modal
function unlockCandidate(analysisId, candidateName, userBalance) {
    // Convert balance to number and check
    userBalance = parseFloat(userBalance);
    
    if (userBalance < 1.00) {
        // Store the current insights page URL in session storage for return after payment
        const currentUrl = window.location.href;
        sessionStorage.setItem('payment_return_url', currentUrl);
        
        // Redirect to top-up page with return URL parameter
        const returnUrl = encodeURIComponent(currentUrl);
        window.location.href = "{{ url_for('payments.wallet') }}?return_to=" + returnUrl;
        return;
    }
    
    // Store data for later use
    unlockAnalysisId = analysisId;
    unlockCandidateName = candidateName;
    unlockUserBalance = parseFloat(userBalance); // Convert to number
    
    // Update modal content
    document.getElementById('modalCurrentBalance').textContent = `$${unlockUserBalance.toFixed(2)}`;
    document.getElementById('modalNewBalance').textContent = `$${(unlockUserBalance - 1.00).toFixed(2)}`;
    document.getElementById('modalCandidateName').textContent = candidateName;
    
    // Show modal with animation
    const modal = document.getElementById('unlockModal');
    modal.style.display = 'block';
    modal.style.opacity = '0';
    setTimeout(() => {
        modal.style.transition = 'opacity 0.3s ease';
        modal.style.opacity = '1';
    }, 10);
}

// Close modal
function closeUnlockModal() {
    const modal = document.getElementById('unlockModal');
    modal.style.opacity = '0';
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

// Confirm unlock and proceed
function confirmUnlock() {
    // Find the unlock button and show loading state
    const confirmBtn = document.getElementById('confirmUnlockBtn');
    const originalText = confirmBtn.innerHTML;
    
    confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
    confirmBtn.disabled = true;
    
    // Make AJAX request to unlock
    fetch(`/unlock-candidate/${unlockAnalysisId}/${encodeURIComponent(unlockCandidateName)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update balance in header
            const balanceEl = document.querySelector('.balance-amount');
            if (balanceEl) {
                balanceEl.textContent = `$${data.new_balance.toFixed(2)}`;
            }
            
            // Show success message in modal
            confirmBtn.innerHTML = '‚úì Success! Reloading...';
            confirmBtn.style.background = '#10b981';
            
            // Reload the page to show new insights (maintains scroll position)
            const scrollPos = window.scrollY;
            sessionStorage.setItem('scrollPosition', scrollPos);
            setTimeout(() => {
                window.location.reload();
            }, 800);
        } else if (data.error === 'Insufficient balance') {
            closeUnlockModal();
            alert('Insufficient balance. Redirecting to top-up page...');
            window.location.href = data.redirect;
        } else {
            closeUnlockModal();
            alert(`Error: ${data.error}\n\nPlease check the browser console for details or try again.`);
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error unlocking candidate:', error);
        closeUnlockModal();
        alert('Failed to unlock insights. Please try again.\n\nMake sure Flask server is running and check browser console for details.');
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('unlockModal');
    if (e.target === modal) {
        closeUnlockModal();
    }
});

// Restore scroll position after reload
window.addEventListener('load', function() {
    const scrollPos = sessionStorage.getItem('scrollPosition');
    if (scrollPos) {
        window.scrollTo(0, parseInt(scrollPos));
        sessionStorage.removeItem('scrollPosition');
    }
    
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>

<!-- Sticky Bottom Bar -->
{% if is_current_draft_analysis %}
{% set show_back_button = True %}
{% set back_url = url_for('results', analysis_id=analysis_id) %}
{% set continue_text = 'Start New Analysis' %}
{% set continue_url = url_for('analyze', new=1) %}
{% set continue_disabled = false %}
{% include 'workflow_bottom_bar.html' %}
{% endif %}
{% endblock %}
