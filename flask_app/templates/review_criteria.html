{% extends "base.html" %}

{% block title %}Job Criteria{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Workflow Progress Indicator -->
    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="display: flex; gap: 10px; align-items: center;">
            <a href="{{ url_for('analyze', step='jd') }}" style="flex: 1; text-align: center; padding: 10px; border-radius: 8px; background: #d1fae5; border: 2px solid #10b981; text-decoration: none; cursor: pointer;" title="View Uploaded JD">
                <div style="font-size: 24px;">âœ…</div>
                <div style="font-size: 12px; font-weight: 600; color: #065f46;">Job Description</div>
            </a>
            <div style="font-size: 20px; color: #10b981;">â†’</div>
            <div style="flex: 1; text-align: center; padding: 12px; border-radius: 8px; background: #1f77b4; border: 2px solid #1565c0; box-shadow: 0 0 10px rgba(31, 119, 180, 0.3);">
                <div style="font-size: 24px; color: white;">âœ…</div>
                <div style="font-size: 12px; font-weight: 600; color: white;">Evaluation Criteria</div>
            </div>
            <div style="font-size: 20px; color: #d1d5db;">â†’</div>
            <a href="{{ url_for('analyze', step='resumes') }}" style="flex: 1; text-align: center; padding: 10px; border-radius: 8px; background: #f3f4f6; border: 2px solid #d1d5db; text-decoration: none; cursor: pointer;" title="Next: Resumes">
                <div style="font-size: 24px;">ğŸ‘¥</div>
                <div style="font-size: 12px; font-weight: 600; color: #6b7280;">Candidate Resumes</div>
            </a>
            <div style="font-size: 20px; color: #d1d5db;">â†’</div>
            <div style="flex: 1; text-align: center; padding: 10px; border-radius: 8px; background: #f3f4f6; border: 2px solid #d1d5db;">
                <div style="font-size: 24px;">ğŸš€</div>
                <div style="font-size: 12px; font-weight: 600; color: #6b7280;">Run Analysis</div>
            </div>
            <div style="font-size: 20px; color: #d1d5db;">â†’</div>
            <div style="flex: 1; text-align: center; padding: 10px; border-radius: 8px; background: #f3f4f6; border: 2px solid #d1d5db;">
                <div style="font-size: 24px;">ğŸ“Š</div>
                <div style="font-size: 12px; font-weight: 600; color: #6b7280;">Results</div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>ğŸ“‹ Job Criteria</h2>
                    <p class="text-muted mb-0">Extracted from: {{ jd_filename }}</p>
                </div>
            </div>

            <!-- Job Title Editor -->
            <div class="card mb-4">
                <div class="card-body">
                    <label for="jobTitleInput" class="form-label fw-bold">ğŸ’¼ Job Title</label>
                    <input type="text" 
                           class="form-control" 
                           id="jobTitleInput" 
                           value="{{ job_title }}"
                           placeholder="Enter job title"
                           style="font-size: 1.1rem;">
                    <small class="text-muted">This will be displayed in the Job History table and exported reports.</small>
                </div>
            </div>

            <!-- Info Box -->
            <div class="alert alert-info mb-4">
                ğŸ’¡ <strong>Tip:</strong> Add, remove, or reword criteria. Uncheck <em>Use</em> to exclude items. Click 'Save Changes' when done, then return to Upload & Analyse to add resumes.
            </div>

            <!-- JD Preview (PDF or Text) -->
            {% if has_pdf %}
            <div class="mb-4">
                <details>
                    <summary style="cursor: pointer; color: #1f77b4; font-weight: 500;">ğŸ“„ View Original PDF File</summary>
                    <div class="mt-2">
                        <iframe src="{{ url_for('view_jd_pdf') }}" width="100%" height="600px" style="border: 1px solid #ddd;"></iframe>
                        <div class="mt-2">
                            <a href="{{ url_for('view_jd_pdf') }}" download="{{ jd_filename }}" class="btn btn-sm btn-outline-primary">
                                â¬‡ï¸ Download PDF
                            </a>
                        </div>
                    </div>
                </details>
            </div>
            {% else %}
            <div class="mb-4">
                <details>
                    <summary style="cursor: pointer; color: #1f77b4; font-weight: 500;">ğŸ“„ View Job Description Text</summary>
                    <div class="mt-2 p-3" style="background: #f8f9fa; border-radius: 4px; max-height: 300px; overflow-y: auto;">
                        <pre style="white-space: pre-wrap; font-size: 0.9rem;">{{ jd_text }}...</pre>
                    </div>
                </details>
            </div>
            {% endif %}

            <!-- Full Text Extract -->
            <div class="mb-4">
                <details>
                    <summary style="cursor: pointer; color: #1f77b4; font-weight: 500;">ğŸ“„ Full Text Extract - used for AI/GPT analysis</summary>
                    <div class="mt-2">
                        <textarea readonly class="form-control" style="font-family: monospace; font-size: 0.85rem; height: 200px; resize: vertical; width: 100%;">{{ jd_text }}</textarea>
                        <div class="mt-2">
                            <small class="text-muted">
                                ğŸ“Š {{ jd_text|length|number_format }} characters extracted 
                                | Extraction method: {{ 'Layout-aware (PyMuPDF)' if has_pdf else 'Direct text' }}
                            </small>
                        </div>
                    </div>
                </details>
            </div>

            <!-- Action Buttons -->
            <div class="mb-3">
                <button id="addCriterion" class="btn btn-success">
                    â• Add New Criterion
                </button>
                <button id="saveChanges" class="btn btn-primary">
                    ğŸ’¾ Save Changes
                </button>
                <button id="resetChanges" class="btn btn-warning">
                    ğŸ”„ Reset
                </button>
                <a href="{{ url_for('export_criteria') }}" class="btn btn-info">
                    ğŸ“¥ Export to CSV
                </a>
                <button id="importButton" class="btn btn-secondary" onclick="document.getElementById('importFile').click();">
                    ğŸ“¤ Import from CSV
                </button>
                <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="importCriteria(this)">
            </div>

            <!-- Criteria Table -->
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="criteriaTable">
                    <thead style="background-color: #f8f9fa;">
                        <tr>
                            <th style="width: 60px;">Use</th>
                            <th style="width: 180px;">Category</th>
                            <th>Criterion</th>
                            <th style="width: 80px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="criteriaBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="mt-3">
                <p class="text-muted">
                    <strong>Total criteria:</strong> <span id="criteriaCount">0</span> |
                    <strong>Active:</strong> <span id="activeCount">0</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px;">
        <h3 id="modalTitle">Edit Criterion</h3>
        <div class="mb-3">
            <label for="criterionText" class="form-label">Criterion Text:</label>
            <textarea id="criterionText" class="form-control" rows="3" style="width: 100%;"></textarea>
        </div>
        <div class="mb-3">
            <label for="categorySelect" class="form-label">Category:</label>
            <select id="categorySelect" class="form-control">
                <option value="Technical Skills">Technical Skills</option>
                <option value="Experience">Experience</option>
                <option value="Qualifications">Qualifications</option>
                <option value="Soft Skills">Soft Skills</option>
                <option value="Responsibilities">Responsibilities</option>
                <option value="Other Requirements">Other Requirements</option>
            </select>
        </div>
        <div class="d-flex justify-content-end gap-2">
            <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="saveEdit()" class="btn btn-primary">Save</button>
        </div>
    </div>
</div>

<script>
let criteriaData = {{ criteria_data | tojson }};
let originalData = JSON.parse(JSON.stringify(criteriaData));
let editingIndex = -1;
let hasChanges = false;

function renderTable() {
    const tbody = document.getElementById('criteriaBody');
    tbody.innerHTML = '';
    
    criteriaData.forEach((item, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td style="text-align: center;">
                <input type="checkbox" ${item.use ? 'checked' : ''} onchange="toggleUse(${index})">
            </td>
            <td>${item.category || 'Uncategorized'}</td>
            <td>${item.criterion}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editCriterion(${index})">âœï¸ Edit</button>
            </td>
        `;
        if (!item.use) {
            row.style.opacity = '0.5';
        }
    });
    
    updateCounts();
}

function updateCounts() {
    document.getElementById('criteriaCount').textContent = criteriaData.length;
    document.getElementById('activeCount').textContent = criteriaData.filter(c => c.use).length;
}

function toggleUse(index) {
    criteriaData[index].use = !criteriaData[index].use;
    markChanged();
    renderTable();
}

function editCriterion(index) {
    editingIndex = index;
    const item = criteriaData[index];
    document.getElementById('modalTitle').textContent = 'Edit Criterion';
    document.getElementById('criterionText').value = item.criterion;
    
    // Populate category dropdown with all existing categories
    populateCategoryDropdown(item.category);
    
    document.getElementById('editModal').style.display = 'block';
}

function populateCategoryDropdown(currentCategory) {
    const select = document.getElementById('categorySelect');
    
    // Get all unique categories from criteria
    const categories = new Set();
    categories.add('Technical Skills');
    categories.add('Experience');
    categories.add('Qualifications');
    categories.add('Soft Skills');
    categories.add('Responsibilities');
    categories.add('Other Requirements');
    
    // Add all categories from existing criteria
    criteriaData.forEach(item => {
        if (item.category) {
            categories.add(item.category);
        }
    });
    
    // Build dropdown options
    select.innerHTML = '';
    const sortedCategories = Array.from(categories).sort();
    sortedCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        if (cat === currentCategory) {
            option.selected = true;
        }
        select.appendChild(option);
    });
    
    // If current category not in list, add it and select it
    if (currentCategory && !categories.has(currentCategory)) {
        const option = document.createElement('option');
        option.value = currentCategory;
        option.textContent = currentCategory;
        option.selected = true;
        select.appendChild(option);
    }
}

function addCriterion() {
    editingIndex = -1;
    document.getElementById('modalTitle').textContent = 'Add New Criterion';
    document.getElementById('criterionText').value = '';
    populateCategoryDropdown('Other Requirements');
    document.getElementById('editModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('editModal').style.display = 'none';
}

function saveEdit() {
    const text = document.getElementById('criterionText').value.trim();
    const category = document.getElementById('categorySelect').value;
    
    if (!text) {
        alert('Please enter criterion text');
        return;
    }
    
    if (editingIndex >= 0) {
        criteriaData[editingIndex].criterion = text;
        criteriaData[editingIndex].category = category;
    } else {
        criteriaData.push({
            criterion: text,
            category: category,
            use: true
        });
    }
    
    markChanged();
    renderTable();
    closeModal();
}

function importCriteria(input) {
    const file = input.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('criteria_file', file);
    
    fetch('{{ url_for("import_criteria") }}', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // Reload the page to show imported criteria
            window.location.reload();
        } else {
            alert('Import Error: ' + data.message);
        }
    })
    .catch(err => {
        alert('Import failed: ' + err);
    });
    
    // Reset file input
    input.value = '';
}

function markChanged() {
    hasChanges = true;
}

function saveChanges() {
    const jobTitle = document.getElementById('jobTitleInput').value.trim();
    
    fetch('{{ url_for("review_criteria") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            criteria: criteriaData,
            job_title: jobTitle
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            hasChanges = false;
            originalData = JSON.parse(JSON.stringify(criteriaData));
            if (data.redirect) {
                window.location.href = data.redirect;
            }
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function resetChanges() {
    if (confirm('Reset to original criteria? This will discard all changes.')) {
        criteriaData = JSON.parse(JSON.stringify(originalData));
        hasChanges = false;
        document.getElementById('changeIndicator').style.display = 'none';
        renderTable();
    }
}

// Event listeners
document.getElementById('addCriterion').addEventListener('click', addCriterion);
document.getElementById('saveChanges').addEventListener('click', saveChanges);
document.getElementById('resetChanges').addEventListener('click', resetChanges);

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', (e) => {
    if (hasChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Initial render
renderTable();
</script>

<style>
.table-hover tbody tr:hover {
    background-color: #f0f4f8;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.form-control {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0.5rem;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    display: block;
}

details summary {
    padding: 0.5rem;
}

details[open] summary {
    margin-bottom: 0.5rem;
}
</style>

{% endblock %}
