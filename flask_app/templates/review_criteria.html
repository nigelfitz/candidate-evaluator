{% extends "base.html" %}

{% block title %}Job Criteria{% endblock %}

{% block content %}

<!-- Include Workflow Stepper -->
{% set current_step = 2 %}
{% include 'workflow_stepper.html' %}

<div class="container mt-4" style="padding-bottom: 120px;">
    <!-- Job Title as Page Header -->
    <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 40px;">
        <label for="jobTitleInput" class="form-label" style="color: #1f2937; font-size: 16px; font-weight: 600; margin-bottom: 12px; display: block;">
            <i data-lucide="briefcase" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"></i>
            Job Title
        </label>
        <input type="text" 
               class="form-control" 
               id="jobTitleInput" 
               value="{{ job_title }}"
               placeholder="Enter job title"
               style="font-size: 0.95rem; font-weight: 500; color: #1f2937; border: 2px solid #e2e8f0; padding: 12px 16px; width: 100%; max-width: none;">
        <small class="text-muted" style="font-size: 13px; margin-top: 6px; display: block;">This will appear in Job History and exported reports</small>
    </div>

    <!-- Info Box -->
    <div class="alert alert-info" style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 16px; margin-bottom: 32px;">
        <i data-lucide="lightbulb" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px; color: #1e40af;"></i>
        <strong>Tip:</strong> Add, remove, or reword criteria or Job Title. Uncheck <em>Use</em> to exclude items. Changes are saved automatically when you continue to the next step.
    </div>

    <!-- Action Buttons -->
    <div class="mb-4" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
        <button id="addCriterion" class="btn btn-success">
            <i data-lucide="plus" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"></i>
            Add New Criterion
        </button>
        
        <!-- Manage Data Dropdown -->
        <div class="dropdown-custom" style="display: inline-block; position: relative;">
            <button class="btn btn-outline-secondary" type="button" id="manageDataDropdown" onclick="toggleManageDropdown(event)">
                <i data-lucide="settings" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"></i>
                Manage Data
                <i data-lucide="chevron-down" style="width: 16px; height: 16px; vertical-align: middle; margin-left: 4px;"></i>
            </button>
            <div class="dropdown-menu-custom" id="manageDataMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000;">
                <a class="dropdown-item-custom" href="{{ url_for('export_criteria') }}" style="display: block; padding: 10px 16px; color: #1f2937; text-decoration: none; transition: background 0.2s;">
                    <i data-lucide="download" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;"></i>
                    Export to CSV
                </a>
                <a class="dropdown-item-custom" href="#" onclick="document.getElementById('importFile').click(); return false;" style="display: block; padding: 10px 16px; color: #1f2937; text-decoration: none; transition: background 0.2s;">
                    <i data-lucide="upload" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;"></i>
                    Import from CSV
                </a>
                <hr style="margin: 4px 0; border: none; border-top: 1px solid #e2e8f0;">
                <a class="dropdown-item-custom" href="#" id="resetChangesDropdown" style="display: block; padding: 10px 16px; color: #f59e0b; text-decoration: none; transition: background 0.2s;">
                    <i data-lucide="rotate-ccw" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;"></i>
                    Reset/Clear All
                </a>
            </div>
        </div>
        <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="importCriteria(this)">
    </div>

    <!-- Criteria Table -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover" id="criteriaTable">
            <thead style="background-color: #f8f9fa;">
                <tr>
                    <th style="width: 60px;">Use</th>
                    <th style="width: 180px;">Category</th>
                    <th>Criterion</th>
                    <th style="width: 80px;">Actions</th>
                </tr>
            </thead>
            <tbody id="criteriaBody">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <p class="text-muted">
            <strong>Total criteria:</strong> <span id="criteriaCount">0</span> |
            <strong>Active:</strong> <span id="activeCount">0</span>
        </p>
    </div>

    <!-- Source Data Accordion (at bottom) -->
    <div class="accordion-custom mt-5" id="sourceDataAccordion" style="border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
        <div class="accordion-header-custom" onclick="toggleSourceAccordion()" style="background: #f8fafc; font-weight: 600; color: #475569; padding: 16px 20px; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
            <div>
                <i data-lucide="file-text" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;"></i>
                Review Source JD
            </div>
            <i data-lucide="chevron-down" id="sourceAccordionIcon" style="width: 20px; height: 20px; transition: transform 0.3s;"></i>
        </div>
        <div id="collapseSourceData" style="display: none; background: white; padding: 20px;">
                    
                    <!-- Original PDF/Text -->
                    {% if has_pdf %}
                    <div class="mb-4">
                        <h5 style="color: #1f2937; font-weight: 600; margin-bottom: 12px;">
                            <i data-lucide="file" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;"></i>
                            Original PDF File
                        </h5>
                        <iframe src="{{ url_for('view_jd_pdf') }}" width="100%" height="600px" style="border: 1px solid #ddd; border-radius: 6px;"></iframe>
                        <div class="mt-2">
                            <a href="{{ url_for('view_jd_pdf') }}" download="{{ jd_filename }}" class="btn btn-sm btn-outline-primary">
                                <i data-lucide="download" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"></i>
                                Download PDF
                            </a>
                        </div>
                    </div>
                    {% else %}
                    <div class="mb-4">
                        <h5 style="color: #1f2937; font-weight: 600; margin-bottom: 12px;">
                            <i data-lucide="file-text" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;"></i>
                            Job Description Text
                        </h5>
                        <div class="p-3" style="background: #f8f9fa; border-radius: 6px; max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0;">
                            <pre style="white-space: pre-wrap; font-size: 0.9rem; margin: 0;">{{ jd_text }}...</pre>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Full Text Extract -->
                    <div>
                        <h5 style="color: #1f2937; font-weight: 600; margin-bottom: 12px;">
                            <i data-lucide="align-left" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;"></i>
                            Full Text Extract (Used for AI Analysis)
                        </h5>
                        <textarea readonly class="form-control" style="font-family: monospace; font-size: 0.85rem; height: 200px; resize: vertical; width: 100%; background: #f8f9fa; border: 1px solid #e2e8f0;">{{ jd_text }}</textarea>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i data-lucide="bar-chart" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i>
                                {{ jd_text|length|number_format }} characters extracted 
                                | Extraction method: {{ 'Layout-aware (PyMuPDF)' if has_pdf else 'Direct text' }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px;">
        <h3 id="modalTitle">Edit Criterion</h3>
        <div class="mb-3">
            <label for="criterionText" class="form-label">Criterion Text:</label>
            <textarea id="criterionText" class="form-control" rows="3" style="width: 100%;"></textarea>
        </div>
        <div class="mb-3">
            <label for="categorySelect" class="form-label">Category:</label>
            <select id="categorySelect" class="form-control">
                <option value="Technical Skills">Technical Skills</option>
                <option value="Experience">Experience</option>
                <option value="Qualifications">Qualifications</option>
                <option value="Soft Skills">Soft Skills</option>
                <option value="Responsibilities">Responsibilities</option>
                <option value="Other Requirements">Other Requirements</option>
            </select>
        </div>
        <div class="d-flex justify-content-end gap-2">
            <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="saveEdit()" class="btn btn-primary">Save</button>
        </div>
    </div>
</div>

<script>
let criteriaData = {{ criteria_data | tojson }};
let originalData = JSON.parse(JSON.stringify(criteriaData));
let editingIndex = -1;
let hasChanges = false;

function renderTable() {
    const tbody = document.getElementById('criteriaBody');
    tbody.innerHTML = '';
    
    criteriaData.forEach((item, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td style="text-align: center;">
                <input type="checkbox" ${item.use ? 'checked' : ''} onchange="toggleUse(${index})">
            </td>
            <td>${item.category || 'Uncategorized'}</td>
            <td>${item.criterion}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editCriterion(${index})">✏️ Edit</button>
            </td>
        `;
        if (!item.use) {
            row.style.opacity = '0.5';
        }
    });
    
    updateCounts();
}

function updateCounts() {
    document.getElementById('criteriaCount').textContent = criteriaData.length;
    document.getElementById('activeCount').textContent = criteriaData.filter(c => c.use).length;
}

function toggleUse(index) {
    criteriaData[index].use = !criteriaData[index].use;
    markChanged();
    renderTable();
}

function editCriterion(index) {
    editingIndex = index;
    const item = criteriaData[index];
    document.getElementById('modalTitle').textContent = 'Edit Criterion';
    document.getElementById('criterionText').value = item.criterion;
    
    // Populate category dropdown with all existing categories
    populateCategoryDropdown(item.category);
    
    document.getElementById('editModal').style.display = 'block';
}

function populateCategoryDropdown(currentCategory) {
    const select = document.getElementById('categorySelect');
    
    // Get all unique categories from criteria
    const categories = new Set();
    categories.add('Technical Skills');
    categories.add('Experience');
    categories.add('Qualifications');
    categories.add('Soft Skills');
    categories.add('Responsibilities');
    categories.add('Other Requirements');
    
    // Add all categories from existing criteria
    criteriaData.forEach(item => {
        if (item.category) {
            categories.add(item.category);
        }
    });
    
    // Build dropdown options
    select.innerHTML = '';
    const sortedCategories = Array.from(categories).sort();
    sortedCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        if (cat === currentCategory) {
            option.selected = true;
        }
        select.appendChild(option);
    });
    
    // If current category not in list, add it and select it
    if (currentCategory && !categories.has(currentCategory)) {
        const option = document.createElement('option');
        option.value = currentCategory;
        option.textContent = currentCategory;
        option.selected = true;
        select.appendChild(option);
    }
}

function addCriterion() {
    editingIndex = -1;
    document.getElementById('modalTitle').textContent = 'Add New Criterion';
    document.getElementById('criterionText').value = '';
    populateCategoryDropdown('Other Requirements');
    document.getElementById('editModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('editModal').style.display = 'none';
}

function saveEdit() {
    const text = document.getElementById('criterionText').value.trim();
    const category = document.getElementById('categorySelect').value;
    
    if (!text) {
        alert('Please enter criterion text');
        return;
    }
    
    if (editingIndex >= 0) {
        criteriaData[editingIndex].criterion = text;
        criteriaData[editingIndex].category = category;
    } else {
        criteriaData.push({
            criterion: text,
            category: category,
            use: true
        });
    }
    
    markChanged();
    renderTable();
    closeModal();
}

function importCriteria(input) {
    const file = input.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('criteria_file', file);
    
    fetch('{{ url_for("import_criteria") }}', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // Reload the page to show imported criteria
            window.location.reload();
        } else {
            alert('Import Error: ' + data.message);
        }
    })
    .catch(err => {
        alert('Import failed: ' + err);
    });
    
    // Reset file input
    input.value = '';
}

function markChanged() {
    hasChanges = true;
}

function saveChanges() {
    const jobTitle = document.getElementById('jobTitleInput').value.trim();
    
    fetch('{{ url_for("review_criteria") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            criteria: criteriaData,
            job_title: jobTitle
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            hasChanges = false;
            originalData = JSON.parse(JSON.stringify(criteriaData));
            if (data.redirect) {
                window.location.href = data.redirect;
            }
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(err => {
        alert('Save failed: ' + err);
    });
}

function resetChanges() {
    if (confirm('Reset to original criteria? This will discard all changes.')) {
        criteriaData = JSON.parse(JSON.stringify(originalData));
        hasChanges = false;
        document.getElementById('changeIndicator').style.display = 'none';
        renderTable();
    }
}

// Event listeners
document.getElementById('addCriterion').addEventListener('click', addCriterion);
document.getElementById('resetChangesDropdown').addEventListener('click', function(e) {
    e.preventDefault();
    resetChanges();
});

// Re-initialize Lucide icons after dropdown is rendered
if (typeof lucide !== 'undefined') {
    lucide.createIcons();
}

// Warn before leaving with unsaved changes (navigation via Continue button will save first)
window.addEventListener('beforeunload', (e) => {
    if (hasChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Initial render
renderTable();

// Dropdown menu functionality
function toggleManageDropdown(event) {
    event.stopPropagation();
    const menu = document.getElementById('manageDataMenu');
    const isVisible = menu.style.display === 'block';
    menu.style.display = isVisible ? 'none' : 'block';
    
    // Re-initialize Lucide icons when dropdown opens
    if (!isVisible && typeof lucide !== 'undefined') {
        setTimeout(() => lucide.createIcons(), 10);
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const menu = document.getElementById('manageDataMenu');
    const dropdown = document.querySelector('.dropdown-custom');
    if (menu && !dropdown.contains(event.target)) {
        menu.style.display = 'none';
    }
});

// Accordion toggle functionality
function toggleSourceAccordion() {
    const content = document.getElementById('collapseSourceData');
    const icon = document.getElementById('sourceAccordionIcon');
    const isOpen = content.style.display === 'block';
    
    content.style.display = isOpen ? 'none' : 'block';
    icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
    
    // Re-initialize Lucide icons when accordion opens
    if (!isOpen && typeof lucide !== 'undefined') {
        setTimeout(() => lucide.createIcons(), 10);
    }
}
</script>

<style>
.dropdown-item-custom:hover {
    background-color: #f0f9ff !important;
}

.table-hover tbody tr:hover {
    background-color: #f0f4f8;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.form-control {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0.5rem;
}

/* Spinner animation */
.spinner-border {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    vertical-align: text-bottom;
    border: 0.15em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border 0.75s linear infinite;
}

.spinner-border-sm {
    width: 0.875rem;
    height: 0.875rem;
    border-width: 0.12em;
}

@keyframes spinner-border {
    to { transform: rotate(360deg); }
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    display: block;
}

details summary {
    padding: 0.5rem;
}

details[open] summary {
    margin-bottom: 0.5rem;
}
</style>

<!-- Include Bottom Bar -->
{% set show_back_button = True %}
{% set back_url = url_for('analyze', step='jd') %}
{% set continue_url = url_for('analyze', step='resumes') %}
{% set continue_text = 'Save and Continue to Upload Resumes →' %}
{% set continue_disabled = False %}
{% set continue_onclick = 'saveAndContinue()' %}
{% include 'workflow_bottom_bar.html' %}

<script>
// Save and continue function - saves changes then navigates
function saveAndContinue() {
    const continueBtn = document.getElementById('continueButton');
    const btnText = document.getElementById('continueButtonText');
    const btnIcon = document.getElementById('continueButtonIcon');
    const btnSpinner = document.getElementById('continueButtonSpinner');
    
    // Show spinner
    btnIcon.style.display = 'none';
    btnSpinner.style.display = 'inline-block';
    btnText.textContent = 'Saving...';
    continueBtn.disabled = true;
    
    // Get current data
    const jobTitle = document.getElementById('jobTitleInput').value.trim();
    
    // Save to backend
    fetch('{{ url_for("review_criteria") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            criteria: criteriaData,
            job_title: jobTitle
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Successfully saved - navigate to next step
            hasChanges = false; // Clear changes flag to prevent beforeunload prompt
            window.location.href = '{{ url_for("analyze", step="resumes") }}';
        } else {
            // Save failed - show error and re-enable button
            alert('Error saving changes: ' + data.message);
            btnSpinner.style.display = 'none';
            btnIcon.style.display = 'inline';
            btnText.textContent = 'Save and Continue to Upload Resumes →';
            continueBtn.disabled = false;
        }
    })
    .catch(err => {
        // Network error - show error and re-enable button
        alert('Save failed: ' + err);
        btnSpinner.style.display = 'none';
        btnIcon.style.display = 'inline';
        btnText.textContent = 'Save and Continue to Upload Resumes →';
        continueBtn.disabled = false;
    });
    
    return false; // Prevent default navigation
}
</script>

{% endblock %}
