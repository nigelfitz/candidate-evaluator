{% extends "admin_base.html" %}

{% block title %}GPT Settings - Admin Panel{% endblock %}

{% block extra_styles %}
.setting-item { border-bottom: 1px solid #f0f0f0; padding: 20px 0; }
        .setting-item:last-child { border-bottom: none; }
        .setting-name { font-weight: 700; color: #1a1a1a; font-size: 1.15rem; margin-bottom: 12px; }
        .setting-value { font-family: 'Courier New', monospace; background: #667eea; color: white; padding: 6px 14px; border-radius: 6px; display: inline-block; font-weight: 600; }
        .setting-desc { color: #555; margin-top: 10px; font-size: 0.95rem; line-height: 1.5; }
        .setting-explanation { background: #f0f4ff; padding: 14px 16px; border-radius: 8px; margin-top: 12px; font-size: 0.9rem; border-left: 3px solid #667eea; }
        .agent-badge { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 8px; }
        .ranker-badge { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .insight-badge { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .profit-card { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; }
        .profit-card h3 { margin: 0; font-size: 1.4rem; }
        .profit-value { font-size: 3rem; font-weight: bold; margin: 15px 0; }
        .profit-breakdown { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; margin-top: 15px; }
        .profit-breakdown div { margin: 5px 0; font-size: 0.95rem; }
        .section-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 18px 24px; border-radius: 12px; margin-bottom: 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .section-header:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        .section-header h3 { margin: 0; font-size: 1.3rem; font-weight: 600; }
        .section-header .toggle-icon { font-size: 1.5rem; transition: transform 0.3s; }
        .section-header.collapsed .toggle-icon { transform: rotate(-90deg); }
        .section-content { padding: 25px; border: 2px solid #f0f0f0; border-top: none; border-radius: 0 0 12px 12px; background: white; }
        .section-content.collapsed { display: none; }
        .section-badge { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 12px; }
        .warning { background: #f8d7da; padding: 12px; border-radius: 8px; border-left: 4px solid #dc3545; margin-bottom: 20px; }
        .success-msg { background: #d4edda; padding: 12px; border-radius: 8px; border-left: 4px solid #28a745; margin-bottom: 20px; }
        .form-range { margin-top: 10px; }
        .range-labels { display: flex; justify-content: space-between; font-size: 0.85rem; color: #666; margin-top: 5px; }
        .logout-btn { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .admin-tabs { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); padding: 15px 30px; margin-bottom: 20px; }
        .admin-tabs a { color: #666; text-decoration: none; padding: 12px 24px; display: inline-block; border-bottom: 3px solid transparent; font-weight: 500; transition: all 0.3s; position: relative; }
        .admin-tabs a:hover { color: #667eea; }
        .admin-tabs a.active { color: #667eea; border-bottom-color: #667eea; }
        
        /* Finance Menu Container */
        .finance-menu-container {
            display: inline-block;
            position: relative;
        }
        
        /* System Settings Menu Container */
        .system-settings-menu-container {
            display: inline-block;
            position: relative;
        }
        
        /* System Settings Dropdown */
        .system-settings-dropdown { 
            display: none; 
            position: absolute; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            min-width: 200px; 
            z-index: 10000; 
            top: 100%; 
            left: 0; 
            border: 1px solid #e0e0e0;
            margin-top: 0;
            padding-top: 8px;
        }
        .system-settings-dropdown a { 
            display: block !important; 
            padding: 12px 20px !important; 
            border-bottom: 1px solid #f0f0f0 !important; 
            font-size: 0.95rem !important;
            position: relative !important;
            color: #666 !important;
            text-decoration: none !important;
        }
        .system-settings-dropdown a:last-child { border-bottom: none !important; }
        .system-settings-dropdown a:hover { background: #f8f9fa !important; color: #667eea !important; }
        
        /* Finance Dropdown */
        .finance-dropdown { 
            display: none; 
            position: absolute; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            min-width: 200px; 
            z-index: 10000; 
            top: 100%; 
            left: 0; 
            border: 1px solid #e0e0e0;
            margin-top: 0;
            padding-top: 8px;
        }
        .finance-dropdown a { 
            display: block !important; 
            padding: 12px 20px !important; 
            border-bottom: 1px solid #f0f0f0 !important; 
            font-size: 0.95rem !important;
            position: relative !important;
            color: #666 !important;
            text-decoration: none !important;
        }
        .finance-dropdown a:last-child { border-bottom: none !important; }
        .finance-dropdown a:hover { background: #f8f9fa !important; color: #667eea !important; }
        
        .session-info { position: fixed; top: 20px; right: 180px; background: rgba(255,255,255,0.95); padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; color: #666; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000; }
.session-info .timeout { font-weight: 600; color: #667eea; }
{% endblock %}

{% block content %}
            <h1 class="text-center mb-4">üéØ Two-Agent AI Configuration</h1>
            
            {% if message %}
            <div class="success-msg">
                ‚úÖ {{ message }}
            </div>
            {% endif %}
            
            <div class="warning">
                <strong>‚ö†Ô∏è Two-Agent System:</strong> RANKER handles bulk scoring (all candidates √ó all criteria). 
                INSIGHT generates deep analysis for selected candidates only. Changes take effect immediately after saving.
            </div>
        </div>
        
        <form method="POST" action="{{ url_for('admin_save_settings') }}">
            <!-- Core Two-Agent Settings -->
            <div class="settings-card">
                <div class="section-header" onclick="toggleSection(this)">
                    <div>
                        <h3 class="mb-0">ü§ñ Core Agent Configuration<span class="section-badge">4 settings</span></h3>
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                
                <!-- RANKER Model -->
                <div class="setting-item">
                    <div class="setting-name">RANKER Model<span class="agent-badge ranker-badge">BULK SCORING</span></div>
                    <select name="ranker_model" class="form-select mt-2" onchange="updateCostEstimate()">
                        {% for option in settings.ranker_model.options %}
                        <option value="{{ option }}" {% if option == settings.ranker_model.value %}selected{% endif %}>
                            {{ option }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="setting-desc">{{ settings.ranker_model.description }}</div>
                    <div class="setting-explanation">
                        <strong>Usage:</strong> {{ settings.ranker_model.usage }}<br>
                        <strong>Explanation:</strong> {{ settings.ranker_model.explanation }}
                    </div>
                    <div class="setting-explanation" style="background: #fff9e6; border-left-color: #ffc107;">
                        <strong>üí∞ Cost:</strong> {{ settings.ranker_model.cost_impact }}
                    </div>
                </div>
                
                <!-- INSIGHT Model -->
                <div class="setting-item">
                    <div class="setting-name">INSIGHT Model<span class="agent-badge insight-badge">DEEP ANALYSIS</span></div>
                    <select name="insight_model" class="form-select mt-2" onchange="updateCostEstimate()">
                        {% for option in settings.insight_model.options %}
                        <option value="{{ option }}" {% if option == settings.insight_model.value %}selected{% endif %}>
                            {{ option }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="setting-desc">{{ settings.insight_model.description }}</div>
                    <div class="setting-explanation">
                        <strong>Usage:</strong> {{ settings.insight_model.usage }}<br>
                        <strong>Explanation:</strong> {{ settings.insight_model.explanation }}
                    </div>
                    <div class="setting-explanation" style="background: #fff9e6; border-left-color: #ffc107;">
                        <strong>üí∞ Cost:</strong> {{ settings.insight_model.cost_impact }}
                    </div>
                </div>
                
                <!-- RANKER Temperature -->
                <div class="setting-item">
                    <div class="setting-name">RANKER Temperature<span class="agent-badge ranker-badge">CONSISTENCY</span></div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="ranker_temperature" class="form-range flex-grow-1" 
                               min="0" max="1" step="0.05" value="{{ settings.ranker_temperature.value }}"
                               oninput="this.nextElementSibling.value = this.value; updateCostEstimate()">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.ranker_temperature.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>0.0 (Deterministic)</span>
                        <span>0.1 (Recommended)</span>
                        <span>1.0 (Creative)</span>
                    </div>
                    <div class="setting-desc">{{ settings.ranker_temperature.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.ranker_temperature.explanation }}
                    </div>
                </div>
                
                <!-- INSIGHT Temperature -->
                <div class="setting-item">
                    <div class="setting-name">INSIGHT Temperature<span class="agent-badge insight-badge">READABILITY</span></div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="insight_temperature" class="form-range flex-grow-1" 
                               min="0" max="1" step="0.05" value="{{ settings.insight_temperature.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.insight_temperature.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>0.0 (Robotic)</span>
                        <span>0.4 (Recommended)</span>
                        <span>1.0 (Creative)</span>
                    </div>
                    <div class="setting-desc">{{ settings.insight_temperature.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.insight_temperature.explanation }}
                    </div>
                </div>
                </div>
            </div>
            
            <!-- Advanced API Settings (Collapsed by Default) -->
            <div class="settings-card">
                <div class="section-header collapsed" onclick="toggleSection(this)">
                    <div>
                        <h3 class="mb-0">‚öôÔ∏è Advanced API Settings<span class="section-badge">Expert Controls</span></h3>
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content collapsed">
                
                <!-- Presence Penalty -->
                <div class="setting-item">
                    <div class="setting-name">Presence Penalty<span class="agent-badge insight-badge">INSIGHT ONLY</span></div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="presence_penalty" class="form-range flex-grow-1" 
                               min="0" max="2" step="0.1" value="{{ settings.advanced_api_settings.presence_penalty.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.advanced_api_settings.presence_penalty.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>0.0 (None)</span>
                        <span>0.4 (Recommended)</span>
                        <span>2.0 (Maximum)</span>
                    </div>
                    <div class="setting-desc">{{ settings.advanced_api_settings.presence_penalty.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.advanced_api_settings.presence_penalty.explanation }}
                    </div>
                </div>
                
                <!-- Frequency Penalty -->
                <div class="setting-item">
                    <div class="setting-name">Frequency Penalty<span class="agent-badge insight-badge">INSIGHT ONLY</span></div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="frequency_penalty" class="form-range flex-grow-1" 
                               min="0" max="2" step="0.1" value="{{ settings.advanced_api_settings.frequency_penalty.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.advanced_api_settings.frequency_penalty.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>0.0 (None)</span>
                        <span>0.3 (Recommended)</span>
                        <span>2.0 (Maximum)</span>
                    </div>
                    <div class="setting-desc">{{ settings.advanced_api_settings.frequency_penalty.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.advanced_api_settings.frequency_penalty.explanation }}
                    </div>
                </div>
                
                <!-- RANKER Max Tokens -->
                <div class="setting-item">
                    <div class="setting-name">RANKER Max Tokens<span class="agent-badge ranker-badge">OUTPUT LIMIT</span></div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="ranker_max_tokens" class="form-range flex-grow-1" 
                               min="200" max="500" step="50" value="{{ settings.advanced_api_settings.ranker_max_tokens.value }}"
                               oninput="this.nextElementSibling.value = this.value; updateCostEstimate()">
                        <output class="setting-value" style="min-width: 80px; text-align: center;">{{ settings.advanced_api_settings.ranker_max_tokens.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>200 (Minimal)</span>
                        <span>300 (Recommended)</span>
                        <span>500 (Detailed)</span>
                    </div>
                    <div class="setting-desc">{{ settings.advanced_api_settings.ranker_max_tokens.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.advanced_api_settings.ranker_max_tokens.explanation }}
                    </div>
                </div>
                
                <!-- INSIGHT Max Tokens -->
                <div class="setting-item">
                    <div class="setting-name">INSIGHT Max Tokens<span class="agent-badge insight-badge">OUTPUT LIMIT</span></div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="insight_max_tokens" class="form-range flex-grow-1" 
                               min="500" max="2000" step="100" value="{{ settings.advanced_api_settings.insight_max_tokens.value }}"
                               oninput="this.nextElementSibling.value = this.value; updateCostEstimate()">
                        <output class="setting-value" style="min-width: 100px; text-align: center;">{{ settings.advanced_api_settings.insight_max_tokens.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>500 (Brief)</span>
                        <span>1000 (Recommended)</span>
                        <span>2000 (Detailed)</span>
                    </div>
                    <div class="setting-desc">{{ settings.advanced_api_settings.insight_max_tokens.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.advanced_api_settings.insight_max_tokens.explanation }}
                    </div>
                </div>
                </div>
            </div>
            
            <!-- Text Processing -->
            <div class="settings-card">
                <div class="section-header" onclick="toggleSection(this)">
                    <div>
                        <h3 class="mb-0">üìÑ Text Processing<span class="section-badge">Cost Control</span></h3>
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                
                <!-- JD Text Chars -->
                <div class="setting-item">
                    <div class="setting-name">Job Description Character Limit</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="jd_text_chars" class="form-range flex-grow-1" 
                               min="1000" max="30000" step="1000" value="{{ settings.text_processing.jd_text_chars.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 80px; text-align: center;">{{ settings.text_processing.jd_text_chars.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>1k (Brief)</span>
                        <span>5k (Recommended)</span>
                        <span>30k (Maximum)</span>
                    </div>
                    <div class="setting-desc">{{ settings.text_processing.jd_text_chars.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.text_processing.jd_text_chars.explanation }}
                    </div>
                </div>
                
                <!-- Candidate Text Chars -->
                <div class="setting-item">
                    <div class="setting-name">Resume Character Limit</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="candidate_text_chars" class="form-range flex-grow-1" 
                               min="4000" max="40000" step="1000" value="{{ settings.text_processing.candidate_text_chars.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 80px; text-align: center;">{{ settings.text_processing.candidate_text_chars.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>4k (Minimal)</span>
                        <span>12k (Recommended)</span>
                        <span>40k (Maximum)</span>
                    </div>
                    <div class="setting-desc">{{ settings.text_processing.candidate_text_chars.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.text_processing.candidate_text_chars.explanation }}
                    </div>
                    <div class="setting-explanation" style="background: #fff9e6; border-left-color: #ffc107;">
                        <strong>üí∞ Cost:</strong> {{ settings.text_processing.candidate_text_chars.cost_impact }}
                    </div>
                </div>
                
                <!-- Evidence Snippet Chars -->
                <div class="setting-item">
                    <div class="setting-name">Evidence Snippet Display Limit</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="evidence_snippet_chars" class="form-range flex-grow-1" 
                               min="300" max="1000" step="100" value="{{ settings.text_processing.evidence_snippet_chars.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 80px; text-align: center;">{{ settings.text_processing.evidence_snippet_chars.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>300 (Brief)</span>
                        <span>500 (Recommended)</span>
                        <span>1000 (Full)</span>
                    </div>
                    <div class="setting-desc">{{ settings.text_processing.evidence_snippet_chars.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.text_processing.evidence_snippet_chars.explanation }}
                    </div>
                </div>
                </div>
            </div>
            
            <!-- Insight Formatting -->
            <div class="settings-card">
                <div class="section-header" onclick="toggleSection(this)">
                    <div>
                        <h3 class="mb-0">‚úçÔ∏è Insight Formatting<span class="section-badge">Output Style</span></h3>
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                
                <!-- Notes Length -->
                <div class="setting-item">
                    <div class="setting-name">Overall Notes Length</div>
                    <select name="notes_length" class="form-select mt-2">
                        {% for option in settings.insight_formatting.notes_length.options %}
                        <option value="{{ option }}" {% if option == settings.insight_formatting.notes_length.value %}selected{% endif %}>
                            {{ option|capitalize }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="setting-desc">{{ settings.insight_formatting.notes_length.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.insight_formatting.notes_length.explanation }}
                    </div>
                    <div class="setting-explanation" style="background: #fff9e6; border-left-color: #ffc107;">
                        <strong>üí∞ Cost:</strong> {{ settings.insight_formatting.notes_length.cost_impact }}
                    </div>
                </div>
                
                <!-- Insight Tone -->
                <div class="setting-item">
                    <div class="setting-name">Insight Tone & Style</div>
                    <select name="insight_tone" class="form-select mt-2">
                        {% for option in settings.insight_formatting.insight_tone.options %}
                        <option value="{{ option }}" {% if option == settings.insight_formatting.insight_tone.value %}selected{% endif %}>
                            {{ option|capitalize }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="setting-desc">{{ settings.insight_formatting.insight_tone.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.insight_formatting.insight_tone.explanation }}
                    </div>
                    <div class="setting-explanation" style="background: #e8f5e9; border-left-color: #4caf50;">
                        <strong>‚ú® Quality:</strong> {{ settings.insight_formatting.insight_tone.quality_impact }}
                    </div>
                </div>
                </div>
            </div>
            
            <!-- Report Balance -->
            <div class="settings-card">
                <div class="section-header" onclick="toggleSection(this)">
                    <div>
                        <h3 class="mb-0">üìä Report Balance<span class="section-badge">Output Control</span></h3>
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                
                <div class="setting-item">
                    <div class="setting-name">Minimum Strengths</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="min_strengths" class="form-range flex-grow-1" 
                               min="1" max="6" step="1" value="{{ settings.report_balance.min_strengths.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.report_balance.min_strengths.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>1 (Minimal)</span>
                        <span>3 (Recommended)</span>
                        <span>6 (Comprehensive)</span>
                    </div>
                    <div class="setting-description">{{ settings.report_balance.min_strengths.description }}</div>
                    <div class="setting-explanation">{{ settings.report_balance.min_strengths.explanation }}</div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-name">Maximum Strengths</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="max_strengths" class="form-range flex-grow-1" 
                               min="3" max="10" step="1" value="{{ settings.report_balance.max_strengths.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.report_balance.max_strengths.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>3 (Concise)</span>
                        <span>6 (Recommended)</span>
                        <span>10 (Exhaustive)</span>
                    </div>
                    <div class="setting-description">{{ settings.report_balance.max_strengths.description }}</div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-name">Minimum Gaps/Concerns</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="min_gaps" class="form-range flex-grow-1" 
                               min="1" max="6" step="1" value="{{ settings.report_balance.min_gaps.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.report_balance.min_gaps.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>1 (Minimal)</span>
                        <span>3 (Recommended)</span>
                        <span>6 (Comprehensive)</span>
                    </div>
                    <div class="setting-description">{{ settings.report_balance.min_gaps.description }}</div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-name">Maximum Gaps/Concerns</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="max_gaps" class="form-range flex-grow-1" 
                               min="3" max="10" step="1" value="{{ settings.report_balance.max_gaps.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.report_balance.max_gaps.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>3 (Concise)</span>
                        <span>6 (Recommended)</span>
                        <span>10 (Exhaustive)</span>
                    </div>
                    <div class="setting-description">{{ settings.report_balance.max_gaps.description }}</div>
                    <div class="cost-impact">{{ settings.report_balance.max_gaps.cost_impact }}</div>
                </div>
                
                </div>
            </div>
            
            <!-- Evidence Depth -->
            <div class="settings-card">
                <div class="section-header" onclick="toggleSection(this)">
                    <div>
                        <h3 class="mb-0">üîç Evidence Depth<span class="section-badge">UI Display</span></h3>
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                
                <div class="setting-item">
                    <div class="setting-name">Evidence Items Per Criterion</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="top_evidence_items" class="form-range flex-grow-1" 
                               min="1" max="10" step="1" value="{{ settings.evidence_depth.top_evidence_items.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.evidence_depth.top_evidence_items.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>1 (Minimal)</span>
                        <span>5 (Recommended)</span>
                        <span>10 (Exhaustive)</span>
                    </div>
                    <div class="setting-description">{{ settings.evidence_depth.top_evidence_items.description }}</div>
                    <div class="setting-explanation">{{ settings.evidence_depth.top_evidence_items.explanation }}</div>
                    <div class="quality-impact">{{ settings.evidence_depth.top_evidence_items.quality_impact }}</div>
                </div>
                
                </div>
            </div>
            
            <!-- Evidence Thresholds -->
            <div class="settings-card">
                <div class="section-header" onclick="toggleSection(this)">
                    <div>
                        <h3 class="mb-0">‚öñÔ∏è Evidence Match Quality<span class="section-badge">Classification</span></h3>
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                
                <div class="setting-item">
                    <div class="setting-name">Strong Match Threshold</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="strong_match_threshold" class="form-range flex-grow-1" 
                               min="0.6" max="0.9" step="0.05" value="{{ settings.evidence_thresholds.strong_match_threshold.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.evidence_thresholds.strong_match_threshold.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>0.6 (Lenient)</span>
                        <span>0.75 (Recommended)</span>
                        <span>0.9 (Strict)</span>
                    </div>
                    <div class="setting-description">{{ settings.evidence_thresholds.strong_match_threshold.description }}</div>
                    <div class="setting-explanation">{{ settings.evidence_thresholds.strong_match_threshold.explanation }}</div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-name">Good Match Threshold</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="good_match_threshold" class="form-range flex-grow-1" 
                               min="0.4" max="0.7" step="0.05" value="{{ settings.evidence_thresholds.good_match_threshold.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.evidence_thresholds.good_match_threshold.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>0.4 (Lenient)</span>
                        <span>0.5 (Recommended)</span>
                        <span>0.7 (Strict)</span>
                    </div>
                    <div class="setting-description">{{ settings.evidence_thresholds.good_match_threshold.description }}</div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-name">Moderate Match Threshold</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="moderate_match_threshold" class="form-range flex-grow-1" 
                               min="0.25" max="0.5" step="0.05" value="{{ settings.evidence_thresholds.moderate_match_threshold.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.evidence_thresholds.moderate_match_threshold.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>0.25 (Lenient)</span>
                        <span>0.35 (Recommended)</span>
                        <span>0.5 (Strict)</span>
                    </div>
                    <div class="setting-description">{{ settings.evidence_thresholds.moderate_match_threshold.description }}</div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-name">Weak Match Threshold</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="weak_match_threshold" class="form-range flex-grow-1" 
                               min="0.1" max="0.3" step="0.05" value="{{ settings.evidence_thresholds.weak_match_threshold.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.evidence_thresholds.weak_match_threshold.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>0.1 (Lenient)</span>
                        <span>0.15 (Recommended)</span>
                        <span>0.3 (Strict)</span>
                    </div>
                    <div class="setting-description">{{ settings.evidence_thresholds.weak_match_threshold.description }}</div>
                    <div class="setting-explanation">{{ settings.evidence_thresholds.weak_match_threshold.explanation }}</div>
                    <div class="quality-impact">{{ settings.evidence_thresholds.weak_match_threshold.quality_impact }}</div>
                </div>
                
                </div>
            </div>
            
            <!-- Score Thresholds -->
            <div class="settings-card">
                <div class="section-header" onclick="toggleSection(this)">
                    <div>
                        <h3 class="mb-0">üéØ Score Thresholds<span class="section-badge">UI Display</span></h3>
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                
                <!-- High Threshold -->
                <div class="setting-item">
                    <div class="setting-name">High/Strong Threshold</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="high_threshold" class="form-range flex-grow-1" 
                               min="0.6" max="0.9" step="0.05" value="{{ settings.score_thresholds.high_threshold.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.score_thresholds.high_threshold.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>0.6 (Lenient)</span>
                        <span>0.75 (Recommended)</span>
                        <span>0.9 (Strict)</span>
                    </div>
                    <div class="setting-desc">{{ settings.score_thresholds.high_threshold.description }}</div>
                </div>
                
                <!-- Low Threshold -->
                <div class="setting-item">
                    <div class="setting-name">Low/Weak Threshold</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="low_threshold" class="form-range flex-grow-1" 
                               min="0.2" max="0.5" step="0.05" value="{{ settings.score_thresholds.low_threshold.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.score_thresholds.low_threshold.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>0.2 (Strict)</span>
                        <span>0.35 (Recommended)</span>
                        <span>0.5 (Lenient)</span>
                    </div>
                    <div class="setting-desc">{{ settings.score_thresholds.low_threshold.description }}</div>
                </div>
                </div>
            </div>
            
            <!-- Usage Notes -->
            <div class="settings-card" style="background: #f8f9fa;">
                <h4>üìö Business Intelligence</h4>
                <div class="mt-3">
                    <p><strong>Current Architecture:</strong> {{ settings._usage_notes.current_architecture }}</p>
                    <p><strong>Typical Analysis Cost:</strong> {{ settings._usage_notes.typical_analysis_cost }}</p>
                    <p><strong>Optimization Priority:</strong> {{ settings._usage_notes.optimization_priority }}</p>
                    <p><strong>Cost Saving Tips:</strong> {{ settings._usage_notes.cost_saving_tips }}</p>
                    <p><strong>Quality Improvement:</strong> {{ settings._usage_notes.quality_improvement_tips }}</p>
                </div>
            </div>
            
            <div class="text-center">
                <button type="submit" class="btn btn-save">üíæ Save Configuration</button>
            </div>
        </form>
{% endblock %}

{% block extra_scripts %}
    <script>
        console.log('Script is running');
        
        // Toggle section collapse
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
            }
        }
        
        // Finance dropdown functionality
        const financeContainer = document.querySelector('.finance-menu-container');
        const dropdown = document.querySelector('.finance-dropdown');
        
        console.log('Finance container:', financeContainer);
        console.log('Dropdown:', dropdown);
        
        if (financeContainer && dropdown) {
            console.log('Setting up dropdown event listeners');
            
            financeContainer.addEventListener('mouseenter', () => {
                console.log('Mouse entered finance container');
                dropdown.style.display = 'block';
            });
            
            financeContainer.addEventListener('mouseleave', () => {
                console.log('Mouse left finance container');
                dropdown.style.display = 'none';
            });
        } else {
            console.error('Finance container or dropdown not found!');
        }
        
        // System Settings dropdown functionality
        const systemContainer = document.querySelector('.system-settings-menu-container');
        const systemDropdown = document.querySelector('.system-settings-dropdown');
        
        if (systemContainer && systemDropdown) {
            systemContainer.addEventListener('mouseenter', () => {
                systemDropdown.style.display = 'block';
            });
            
            systemContainer.addEventListener('mouseleave', () => {
                systemDropdown.style.display = 'none';
            });
        }
    </script>
{% endblock %}
