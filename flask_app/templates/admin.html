<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Settings - Candidate Evaluator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .admin-container { max-width: 1200px; margin: 0 auto; }
        .settings-card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); padding: 30px; margin-bottom: 20px; }
        .setting-item { border-bottom: 1px solid #e0e0e0; padding: 20px 0; }
        .setting-item:last-child { border-bottom: none; }
        .setting-name { font-weight: 600; color: #333; font-size: 1.1rem; }
        .setting-value { font-family: 'Courier New', monospace; background: #f8f9fa; padding: 5px 10px; border-radius: 5px; display: inline-block; }
        .setting-desc { color: #666; margin-top: 8px; font-size: 0.95rem; }
        .setting-explanation { background: #e3f2fd; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }
        .cost-impact { background: #fff3cd; padding: 8px 12px; border-radius: 5px; margin-top: 8px; border-left: 4px solid #ffc107; }
        .quality-impact { background: #d1ecf1; padding: 8px 12px; border-radius: 5px; margin-top: 8px; border-left: 4px solid #17a2b8; }
        .warning { background: #f8d7da; padding: 12px; border-radius: 8px; border-left: 4px solid #dc3545; margin-bottom: 20px; }
        .success-msg { background: #d4edda; padding: 12px; border-radius: 8px; border-left: 4px solid #28a745; margin-bottom: 20px; }
        .btn-save { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 12px 30px; font-size: 1.1rem; }
        .btn-save:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .form-range { margin-top: 10px; }
        .range-labels { display: flex; justify-content: space-between; font-size: 0.85rem; color: #666; margin-top: 5px; }
        .current-cost { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .current-cost h3 { margin: 0; font-size: 1.3rem; }
        .current-cost .cost-value { font-size: 2.5rem; font-weight: bold; margin: 10px 0; }
        .section-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; }
        .logout-btn { position: fixed; top: 20px; right: 20px; }
    </style>
</head>
<body>
    <a href="{{ url_for('admin_logout') }}" class="btn btn-danger logout-btn">üîí Logout</a>
    
    <div class="admin-container">
        <div class="settings-card">
            <h1 class="text-center mb-4">‚öôÔ∏è Admin Settings Panel</h1>
            
            {% if message %}
            <div class="success-msg">
                ‚úÖ {{ message }}
            </div>
            {% endif %}
            
            <div class="warning">
                <strong>‚ö†Ô∏è Important:</strong> Changes to these settings affect both quality and cost of GPT insights. 
                Always test with "Top 3" insights first before processing large batches. Changes take effect immediately 
                after saving (server restart not required).
            </div>
            
            <div class="current-cost">
                <h3>Current Cost Per Insight</h3>
                <div class="cost-value" id="currentCost">~$0.018</div>
                <small>Based on current settings with {{ settings.gpt_model.value }} model</small>
            </div>
        </div>
        
        <form method="POST" action="{{ url_for('admin_save_settings') }}">
            <!-- Core GPT Settings -->
            <div class="settings-card">
                <div class="section-header">
                    <h3 class="mb-0">ü§ñ Core GPT Settings</h3>
                </div>
                
                <!-- Model Selection -->
                <div class="setting-item">
                    <div class="setting-name">GPT Model</div>
                    <select name="gpt_model" class="form-select mt-2" onchange="updateCostEstimate()">
                        {% for option in settings.gpt_model.options %}
                        <option value="{{ option }}" {% if option == settings.gpt_model.value %}selected{% endif %}>
                            {{ option }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="setting-desc">{{ settings.gpt_model.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.gpt_model.explanation }}
                    </div>
                    <div class="cost-impact">
                        <strong>üí∞ Cost Impact:</strong> {{ settings.gpt_model.cost_impact }}
                    </div>
                    <div class="quality-impact">
                        <strong>‚ú® Quality Impact:</strong> {{ settings.gpt_model.quality_impact }}
                    </div>
                </div>
                
                <!-- Temperature -->
                <div class="setting-item">
                    <div class="setting-name">Temperature</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="temperature" class="form-range flex-grow-1" 
                               min="0" max="2" step="0.1" value="{{ settings.temperature.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.temperature.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>0.0 (Deterministic)</span>
                        <span>1.0 (Balanced)</span>
                        <span>2.0 (Creative)</span>
                    </div>
                    <div class="setting-desc">{{ settings.temperature.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.temperature.explanation }}
                        <br><strong>Recommended:</strong> {{ settings.temperature.recommended }}
                    </div>
                    <div class="quality-impact">
                        <strong>‚ú® Quality Impact:</strong> {{ settings.temperature.quality_impact }}
                    </div>
                </div>
                
                <!-- Max Tokens -->
                <div class="setting-item">
                    <div class="setting-name">Max Response Tokens</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="max_tokens" class="form-range flex-grow-1" 
                               min="500" max="2000" step="100" value="{{ settings.max_tokens.value }}"
                               oninput="this.nextElementSibling.value = this.value; updateCostEstimate()">
                        <output class="setting-value" style="min-width: 80px; text-align: center;">{{ settings.max_tokens.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>500 (Minimal)</span>
                        <span>1000 (Recommended)</span>
                        <span>2000 (Maximum)</span>
                    </div>
                    <div class="setting-desc">{{ settings.max_tokens.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.max_tokens.explanation }}
                    </div>
                    <div class="cost-impact">
                        <strong>üí∞ Cost Impact:</strong> {{ settings.max_tokens.cost_impact }}
                    </div>
                </div>
            </div>
            
            <!-- Context Settings -->
            <div class="settings-card">
                <div class="section-header">
                    <h3 class="mb-0">üìÑ Context & Evidence Settings</h3>
                </div>
                
                <!-- Evidence Snippet Length -->
                <div class="setting-item">
                    <div class="setting-name">Evidence Snippet Characters</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="evidence_snippet_chars" class="form-range flex-grow-1" 
                               min="200" max="1000" step="100" value="{{ settings.evidence_snippet_chars.value }}"
                               oninput="this.nextElementSibling.value = this.value; updateCostEstimate()">
                        <output class="setting-value" style="min-width: 80px; text-align: center;">{{ settings.evidence_snippet_chars.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>200 (Brief)</span>
                        <span>600 (Recommended)</span>
                        <span>1000 (Detailed)</span>
                    </div>
                    <div class="setting-desc">{{ settings.evidence_snippet_chars.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.evidence_snippet_chars.explanation }}
                    </div>
                    <div class="cost-impact">
                        <strong>üí∞ Cost Impact:</strong> {{ settings.evidence_snippet_chars.cost_impact }}
                    </div>
                    <div class="quality-impact">
                        <strong>‚ú® Quality Impact:</strong> {{ settings.evidence_snippet_chars.quality_impact }}
                    </div>
                </div>
                
                <!-- Candidate Text Length -->
                <div class="setting-item">
                    <div class="setting-name">Candidate Resume Text Characters</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="candidate_text_chars" class="form-range flex-grow-1" 
                               min="1000" max="10000" step="1000" value="{{ settings.candidate_text_chars.value }}"
                               oninput="this.nextElementSibling.value = this.value; updateCostEstimate()">
                        <output class="setting-value" style="min-width: 100px; text-align: center;">{{ settings.candidate_text_chars.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>1000</span>
                        <span>3000 (Recommended)</span>
                        <span>10000</span>
                    </div>
                    <div class="setting-desc">{{ settings.candidate_text_chars.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.candidate_text_chars.explanation }}
                    </div>
                    <div class="cost-impact">
                        <strong>üí∞ Cost Impact:</strong> {{ settings.candidate_text_chars.cost_impact }}
                    </div>
                </div>
                
                <!-- JD Text Length -->
                <div class="setting-item">
                    <div class="setting-name">Job Description Text Characters</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="jd_text_chars" class="form-range flex-grow-1" 
                               min="1000" max="10000" step="1000" value="{{ settings.jd_text_chars.value }}"
                               oninput="this.nextElementSibling.value = this.value; updateCostEstimate()">
                        <output class="setting-value" style="min-width: 100px; text-align: center;">{{ settings.jd_text_chars.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>1000</span>
                        <span>3000 (Recommended)</span>
                        <span>10000</span>
                    </div>
                    <div class="setting-desc">{{ settings.jd_text_chars.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.jd_text_chars.explanation }}
                    </div>
                    <div class="cost-impact">
                        <strong>üí∞ Cost Impact:</strong> {{ settings.jd_text_chars.cost_impact }}
                    </div>
                </div>
                
                <!-- Top Evidence Items -->
                <div class="setting-item">
                    <div class="setting-name">Number of Evidence Items to Include</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="top_evidence_items" class="form-range flex-grow-1" 
                               min="5" max="20" step="1" value="{{ settings.advanced_settings.top_evidence_items.value }}"
                               oninput="this.nextElementSibling.value = this.value; updateCostEstimate()">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.advanced_settings.top_evidence_items.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>5 (Minimal)</span>
                        <span>10 (Recommended)</span>
                        <span>20 (Maximum)</span>
                    </div>
                    <div class="setting-desc">{{ settings.advanced_settings.top_evidence_items.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.advanced_settings.top_evidence_items.explanation }}
                    </div>
                    <div class="cost-impact">
                        <strong>üí∞ Cost Impact:</strong> {{ settings.advanced_settings.top_evidence_items.cost_impact }}
                    </div>
                </div>
            </div>
            
            <!-- Score Thresholds -->
            <div class="settings-card">
                <div class="section-header">
                    <h3 class="mb-0">üéØ Score Thresholds</h3>
                </div>
                
                <!-- High Threshold -->
                <div class="setting-item">
                    <div class="setting-name">High/Strong Threshold</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="high_threshold" class="form-range flex-grow-1" 
                               min="0.6" max="0.9" step="0.05" value="{{ settings.score_thresholds.high_threshold.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.score_thresholds.high_threshold.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>0.6 (Lenient)</span>
                        <span>0.75 (Recommended)</span>
                        <span>0.9 (Strict)</span>
                    </div>
                    <div class="setting-desc">{{ settings.score_thresholds.high_threshold.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.score_thresholds.high_threshold.explanation }}
                    </div>
                </div>
                
                <!-- Low Threshold -->
                <div class="setting-item">
                    <div class="setting-name">Low/Weak Threshold</div>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <input type="range" name="low_threshold" class="form-range flex-grow-1" 
                               min="0.2" max="0.5" step="0.05" value="{{ settings.score_thresholds.low_threshold.value }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="setting-value" style="min-width: 60px; text-align: center;">{{ settings.score_thresholds.low_threshold.value }}</output>
                    </div>
                    <div class="range-labels">
                        <span>0.2 (Strict)</span>
                        <span>0.35 (Recommended)</span>
                        <span>0.5 (Lenient)</span>
                    </div>
                    <div class="setting-desc">{{ settings.score_thresholds.low_threshold.description }}</div>
                    <div class="setting-explanation">
                        <strong>Explanation:</strong> {{ settings.score_thresholds.low_threshold.explanation }}
                    </div>
                </div>
            </div>
            
            <!-- Usage Notes -->
            <div class="settings-card" style="background: #f8f9fa;">
                <h4>üìö Usage Notes & Recommendations</h4>
                <div class="mt-3">
                    <p><strong>Current Cost Per Insight:</strong> {{ settings._usage_notes.current_cost_per_insight }}</p>
                    <p><strong>Recommended Workflow:</strong> {{ settings._usage_notes.recommended_workflow }}</p>
                    <p><strong>Optimization Priority:</strong> {{ settings._usage_notes.optimization_priority }}</p>
                    <p><strong>Cost Saving Tips:</strong> {{ settings._usage_notes.cost_saving_tips }}</p>
                    <p><strong>Quality Improvement Tips:</strong> {{ settings._usage_notes.quality_improvement_tips }}</p>
                </div>
            </div>
            
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-save">üíæ Save All Settings</button>
            </div>
        </form>
    </div>
    
    <script>
        function updateCostEstimate() {
            // Get current values
            const model = document.querySelector('select[name="gpt_model"]').value;
            const maxTokens = parseInt(document.querySelector('input[name="max_tokens"]').value);
            const evidenceChars = parseInt(document.querySelector('input[name="evidence_snippet_chars"]').value);
            const candidateChars = parseInt(document.querySelector('input[name="candidate_text_chars"]').value);
            const jdChars = parseInt(document.querySelector('input[name="jd_text_chars"]').value);
            const evidenceItems = parseInt(document.querySelector('input[name="top_evidence_items"]').value);
            
            // Model costs (per million tokens)
            const costs = {
                'gpt-4o': { input: 2.5, output: 10.0 },
                'gpt-4o-mini': { input: 0.15, output: 0.6 },
                'gpt-4-turbo': { input: 10.0, output: 30.0 },
                'gpt-4': { input: 30.0, output: 60.0 }
            };
            
            // Estimate tokens (~4 chars per token)
            const evidenceTokens = (evidenceChars * evidenceItems) / 4;
            const candidateTokens = candidateChars / 4;
            const jdTokens = jdChars / 4;
            const promptOverhead = 200; // System prompt, schema, formatting
            
            const totalInputTokens = evidenceTokens + candidateTokens + jdTokens + promptOverhead;
            const outputTokens = maxTokens * 0.5; // Typically use ~50% of max
            
            const inputCost = (totalInputTokens / 1000000) * costs[model].input;
            const outputCost = (outputTokens / 1000000) * costs[model].output;
            const totalCost = inputCost + outputCost;
            
            document.getElementById('currentCost').textContent = '~$' + totalCost.toFixed(3);
        }
        
        // Update cost estimate on page load
        updateCostEstimate();
    </script>
</body>
</html>
