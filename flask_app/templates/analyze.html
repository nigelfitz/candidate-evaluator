{% extends "base.html" %}

{% block title %}Analyze Candidates{% endblock %}

{% block content %}

<!-- Include Workflow Stepper -->
{% set step_name = current_step %}
{% set current_step = 1 if step_name == 'jd' else 3 %}
{% include 'workflow_stepper.html' %}

<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 40px 20px 120px 20px;">
    {% if current_user.balance_usd < 5 %}
    <div class="alert alert-warning mb-3" style="padding: 1rem;">
        <i data-lucide="alert-triangle" style="width: 18px; height: 18px; margin-right: 6px;"></i>
        Low Balance: ${{ "%.2f"|format(current_user.balance_usd) }}
    </div>
    {% endif %}

<!-- STEP 1: Upload Job Description (only show if step=jd or no JD uploaded) -->
{% if step_name == 'jd' %}
{% if jd_data and jd_data.filename %}
<!-- Show uploaded JD file info with delete option -->
<div
    style="background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h2 style="color: #1f2937; margin-bottom: 20px; font-size: 20px;">üìù Uploaded Job Description</h2>

    <div
        style="display: flex; align-items: center; justify-content: space-between; padding: 15px; border: 2px solid #10b981; border-radius: 8px; margin-bottom: 20px; background: #d1fae5;">
        <div style="flex: 1;">
            <div style="font-weight: 600; color: #065f46; font-size: 16px;">‚úÖ {{ jd_data.filename }}</div>
            {% if jd_data.text %}
            <div style="font-size: 14px; color: #059669; margin-top: 5px;">{{ jd_data.text|length }} characters
                extracted</div>
            {% endif %}
        </div>
        <form method="POST" action="{{ url_for('analysis.clear_session') }}" style="display: inline;"
            onsubmit="return confirm('Delete this JD and start over? This will also clear criteria and uploaded resumes.')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è Delete JD</button>
        </form>
    </div>

    {% if jd_data.text %}
    <details style="margin-bottom: 20px;">
        <summary
            style="cursor: pointer; color: #1f77b4; font-weight: 600; padding: 10px; background: #f0f9ff; border-radius: 6px;">
            üëÅÔ∏è Preview JD Text</summary>
        <div
            style="background: #f9fafb; padding: 15px; border-radius: 6px; margin-top: 10px; font-family: monospace; font-size: 13px; max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb;">
            {{ jd_data.text }}{% if jd_data.text|length >= 500 %}...
            <div style="margin-top: 10px; color: #6b7280; font-style: italic;">(Showing first 500 characters)</div>
            {% endif %}
        </div>
    </details>
    {% endif %}
</div>
{% else %}
<!-- Show upload form -->
<form method="POST" action="{{ url_for('analysis.analyze') }}" enctype="multipart/form-data" id="jdForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="action" value="upload_jd">

    <div
        style="background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h2 style="color: #1f2937; margin-bottom: 20px; font-size: 24px; font-weight: 600;">Step 1: Job Description</h2>

        <!-- Large Dashed Dropzone -->
        <div id="dropzone"
            style="margin-bottom: 20px; padding: 60px 30px; border: 3px dashed #3b82f6; border-radius: 12px; background: #f0f9ff; text-align: center; cursor: pointer; transition: all 0.3s ease;">
            <input type="file" name="job_description" id="jdFile" accept=".pdf,.docx,.doc,.txt" style="display: none;">
            <div id="dropzoneContent">
                <i data-lucide="upload-cloud"
                    style="width: 64px; height: 64px; color: #3b82f6; margin-bottom: 16px;"></i>
                <h3 style="color: #1e40af; font-size: 20px; margin-bottom: 8px; font-weight: 600;">Drop your Job
                    Description here</h3>
                <p style="color: #64748b; font-size: 16px; margin-bottom: 16px;">or click to browse</p>
                <p style="color: #94a3b8; font-size: 14px;">Supports PDF, DOCX, DOC, TXT files</p>
            </div>
            <div id="fileSelectedInfo" style="display: none;">
                <i data-lucide="file-check" style="width: 48px; height: 48px; color: #16a34a; margin-bottom: 12px;"></i>
                <p id="selectedFileName" style="color: #16a34a; font-size: 18px; font-weight: 600; margin: 0;"></p>
            </div>
        </div>

        <div style="text-align: center; margin: 30px 0; color: #6b7280; font-weight: 500; font-size: 16px;">OR</div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 8px; font-size: 16px;">
                <i data-lucide="file-text"
                    style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;"></i>
                Paste JD Text
            </label>
            <textarea name="jd_text" id="jdText" rows="10" placeholder="Paste your job description here..."
                style="display: block; width: 100%; padding: 16px; border: 2px solid #d1d5db; border-radius: 8px; font-family: monospace; font-size: 14px; line-height: 1.6;"></textarea>
        </div>
    </div>
</form>
{% endif %}
{% endif %}

<!-- STEP 2: Upload Resumes (only show if step=resumes and JD uploaded) -->
{% if step_name == 'resumes' and jd_data %}

<!-- Show list of uploaded resumes if any exist -->
{% if uploaded_resumes %}
<div
    style="background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h2 style="color: #1f2937; margin-bottom: 20px; font-size: 20px;">üìÅ Uploaded Resumes ({{ uploaded_resumes|length
        }})</h2>

    <div style="margin-bottom: 20px;">
        {% for resume in uploaded_resumes %}
        <div
            style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; background: #f9fafb;">
            <div style="flex: 1;">
                <div style="font-weight: 600; color: #1f2937;">{{ resume.candidate_name }}</div>
                <div style="font-size: 14px; color: #6b7280;">{{ resume.file_name }}</div>
            </div>
            <form method="POST" action="{{ url_for('analysis.delete_resume', resume_id=resume.id) }}" style="display: inline;"
                onsubmit="return confirm('Remove this resume?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è Remove</button>
            </form>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Upload more resumes form -->
<div id="upload-resumes"></div>
<form method="POST" action="{{ url_for('analysis.analyze') }}" enctype="multipart/form-data" id="resumeUploadForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="action" value="upload_resumes">
    <input type="hidden" name="override_limit" id="overrideLimitField" value="false">

    <div
        style="background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h2 style="color: #1f2937; margin-bottom: 20px; font-size: 24px; font-weight: 600;">{% if uploaded_resumes %}Add
            More Resumes{% else %}Step 3: Upload Resumes{% endif %}</h2>

        <!-- Alert Bar -->
        <div
            style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px; flex-shrink: 0;">‚ö†Ô∏è</span>
            <span style="color: #856404; font-size: 14px; font-weight: 500; flex-grow: 1;">
                <strong>Important:</strong> Please ensure all resume files are closed on your desktop before uploading.
            </span>
            <div style="position: relative; display: inline-block;">
                <span class="info-icon"
                    style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; border-radius: 50%; background: #ffc107; color: #856404; font-size: 12px; font-weight: bold; cursor: help; flex-shrink: 0;">i</span>
                <div class="tooltip-content"
                    style="display: none; position: absolute; bottom: 125%; right: -80px; background: #1e293b; color: white; padding: 10px 12px; border-radius: 6px; font-size: 13px; line-height: 1.4; width: 240px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000;">
                    Our AI requires exclusive access to files to perform a Deep Dive analysis. Open files may cause the
                    upload to fail.
                    <div
                        style="position: absolute; top: 100%; right: 90px; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid #1e293b;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Large Dashed Dropzone for Resumes -->
        <div id="resumeDropzone"
            style="margin-bottom: 20px; padding: 60px 30px; border: 3px dashed #3b82f6; border-radius: 12px; background: #f0f9ff; text-align: center; cursor: pointer; transition: all 0.3s ease;">
            <input type="file" name="resumes" id="resumeFiles" accept=".pdf,.docx,.doc,.txt" multiple
                style="display: none;">
            <div id="resumeDropzoneContent">
                <i data-lucide="users" style="width: 64px; height: 64px; color: #3b82f6; margin-bottom: 16px;"></i>
                <h3 style="color: #1e40af; font-size: 20px; margin-bottom: 8px; font-weight: 600;">Drop candidate
                    resumes here</h3>
                <p style="color: #64748b; font-size: 16px; margin-bottom: 16px;">Ensure files are closed, then drag here
                    or click to browse.</p>
                <p style="color: #94a3b8; font-size: 14px;">Supports PDF, DOCX, DOC, TXT ‚Ä¢ Select multiple files at once
                </p>
            </div>
        </div>
        <div id="selectedResumesList" style="margin-top: 20px;"></div>
    </div>
</form>
{% endif %}
</div>

<!-- Resume Upload Loading Overlay -->
<div id="resumeUploadOverlay"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 9999; justify-content: center; align-items: center;">
    <div
        style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 20px; padding: 60px 80px; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4); text-align: center; max-width: 600px; border: 3px solid rgba(255, 255, 255, 0.2);">
        <div
            style="width: 100px; height: 100px; margin: 0 auto 32px; border: 5px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite;">
        </div>
        <h2 style="color: white; font-size: 32px; font-weight: 700; margin-bottom: 16px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">üì§ Processing Your Resumes</h2>
        <p id="resumeUploadCount" style="color: rgba(255, 255, 255, 0.95); font-size: 20px; margin-bottom: 12px; font-weight: 600;">
            Uploading files...</p>
        <p style="color: rgba(255, 255, 255, 0.85); font-size: 16px; margin-bottom: 24px;">Please don't close this window while we process your uploads</p>
        
        <!-- Progress bar -->
        <div style="background: rgba(255, 255, 255, 0.2); height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 20px;">
            <div style="background: white; height: 100%; width: 100%; animation: progressPulse 3s ease-in-out infinite;"></div>
        </div>
        
        <p id="largeUploadWarning"
            style="display: none; color: rgba(255, 255, 255, 0.9); font-size: 15px; margin-top: 20px; padding: 20px; background: rgba(0, 0, 0, 0.2); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.2);">
            ‚è±Ô∏è <strong>Large batch detected!</strong><br>
            Processing this many files takes a few minutes. Please be patient - we're working on it!</p>
    </div>
</div>

<style>
@keyframes progressPulse {
    0%, 100% { transform: translateX(-100%); }
    50% { transform: translateX(100%); }
}
</style>

<!-- Resume Limit Warning Modal -->
<div id="resumeLimitModal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 10000; justify-content: center; align-items: center; padding: 20px;">
    <div
        style="background: white; border-radius: 16px; padding: 40px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <div style="text-align: center; margin-bottom: 24px;">
            <div
                style="width: 64px; height: 64px; margin: 0 auto 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <span style="font-size: 32px;">‚ö†Ô∏è</span>
            </div>
            <h3 style="color: #1f2937; font-size: 24px; font-weight: 600; margin-bottom: 8px;">Large Batch Detected</h3>
            <p id="resumeLimitMessage" style="color: #64748b; font-size: 16px;"></p>
        </div>

        <div
            style="background: #f8fafc; border-left: 4px solid #3b82f6; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
            <h4 style="color: #1e40af; font-size: 16px; font-weight: 600; margin-bottom: 12px;">üí° Recommended Approach:
            </h4>
            <ol style="color: #475569; font-size: 14px; line-height: 1.6; margin: 0; padding-left: 20px;">
                <li style="margin-bottom: 8px;"><strong>Process in smaller batches</strong> (e.g., 100 resumes per
                    batch)</li>
                <li style="margin-bottom: 8px;"><strong>Identify top potential candidates</strong> from each batch</li>
                <li style="margin-bottom: 8px;"><strong>Run one final job</strong> which includes only the top potential
                    candidates</li>
            </ol>
            <p style="color: #64748b; font-size: 13px; margin: 12px 0 0 0; line-height: 1.5;">
                This works equally well for processing applications as they arrive‚Äîget early insights into candidate
                quality, then run a final comparison with only genuine contenders.
            </p>
        </div>

        <div
            style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
            <p style="color: #78350f; font-size: 14px; margin: 0; line-height: 1.6;">
                <strong>üöÄ Coming Soon:</strong> We're actively developing enterprise features to better handle
                large-volume recruitment. In the meantime, the approach above will give you great results while staying
                within optimal processing limits.
            </p>
        </div>

        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button onclick="closeResumeLimitModal()"
                style="flex: 1; min-width: 200px; padding: 14px 24px; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);">
                ‚Üê Go Back to Revise Upload
            </button>
            <button onclick="tryAnywayWithWarning()"
                style="flex: 1; min-width: 200px; padding: 14px 24px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                ‚ö° Try All <span id="fullCount"></span> Anyway
            </button>
        </div>

        <p style="color: #94a3b8; font-size: 11px; text-align: center; margin: 12px 0 0 0; line-height: 1.4;">
            Note: Processing large batches may be slower and could encounter rate limits or timeouts
        </p>
    </div>
</div>

<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== Tooltip Hover Functionality =====
    const infoIcon = document.querySelector('.info-icon');
    const tooltipContent = document.querySelector('.tooltip-content');

    if (infoIcon && tooltipContent) {
        infoIcon.addEventListener('mouseenter', () => {
            tooltipContent.style.display = 'block';
        });

        infoIcon.addEventListener('mouseleave', () => {
            tooltipContent.style.display = 'none';
        });
    }

    // ===== JD Dropzone Functionality =====
    const dropzone = document.getElementById('dropzone');
    const jdFileInput = document.getElementById('jdFile');
    const dropzoneContent = document.getElementById('dropzoneContent');
    const fileSelectedInfo = document.getElementById('fileSelectedInfo');
    const selectedFileName = document.getElementById('selectedFileName');
    const jdText = document.getElementById('jdText');

    console.log('Dropzone elements:', { dropzone, jdFileInput, dropzoneContent, fileSelectedInfo });

    if (dropzone && jdFileInput) {
        console.log('Setting up dropzone event listeners...');
        
        // Click to browse
        dropzone.addEventListener('click', () => {
            console.log('Dropzone clicked');
            jdFileInput.click();
        });

        // File input change
        jdFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                selectedFileName.textContent = file.name;
                dropzoneContent.style.display = 'none';
                fileSelectedInfo.style.display = 'block';
                dropzone.style.borderColor = '#16a34a';
                dropzone.style.background = '#d1fae5';
                if (jdText) jdText.disabled = true;

                // Enable and update button text
                updateContinueButton(true);
                updateContinueButtonText('Extract Criteria with AI');
            }
        });

        // Drag and drop
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = '#2563eb';
            dropzone.style.background = '#dbeafe';
        });

        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = '#3b82f6';
            dropzone.style.background = '#f0f9ff';
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = '#3b82f6';
            dropzone.style.background = '#f0f9ff';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                jdFileInput.files = files;
                jdFileInput.dispatchEvent(new Event('change'));
            }
        });
    }

    // JD Text area
    if (jdText) {
        jdText.addEventListener('input', (e) => {
            const hasText = e.target.value.trim().length > 0;
            updateContinueButton(hasText);
            if (hasText) {
                updateContinueButtonText('Extract Criteria with AI');
            }
        });
    }

    // Helper to update button state
    function updateContinueButton(enabled) {
        const btn = document.getElementById('continueButton');
        if (btn) {
            btn.disabled = !enabled;
        }
    }

    // Helper to update button text
    function updateContinueButtonText(text) {
        const btnText = document.getElementById('continueButtonText');
        if (btnText) {
            btnText.textContent = text;
        }
    }

    // Resume limit configuration (from backend)
    const MAX_RESUMES_PER_UPLOAD = {{ system_settings.get('max_resumes_per_upload', {}).get('value', 200) if system_settings else 200 }};
    let proceedWithAllFiles = false;  // Flag to allow override

    // ===== Resume Dropzone Functionality =====
    const resumeDropzone = document.getElementById('resumeDropzone');
    const resumeFiles = document.getElementById('resumeFiles');
    const resumeDropzoneContent = document.getElementById('resumeDropzoneContent');
    const selectedResumesList = document.getElementById('selectedResumesList');
    const uploadResumesBtn = document.getElementById('uploadResumesBtn');

    let selectedFiles = [];

    if (resumeDropzone && resumeFiles) {
        // Click to browse
        resumeDropzone.addEventListener('click', () => resumeFiles.click());

        // File input change
        resumeFiles.addEventListener('change', async (e) => {
            const newFiles = Array.from(e.target.files);

            // Validate files for locks BEFORE adding them
            for (let file of newFiles) {
                try {
                    // Try to read first 1KB to check if file is accessible
                    await file.slice(0, 1024).arrayBuffer();
                } catch (err) {
                    // File is locked!
                    alert(`‚ö†Ô∏è Cannot add "${file.name}"\n\nThis file is currently open in another program. Please close it first, then try adding it again.`);
                    // Clear the file input so user can retry
                    resumeFiles.value = '';
                    return; // Don't add any files from this selection
                }
            }

            // All files are accessible - add them
            newFiles.forEach(file => {
                if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                }
            });

            // Check if exceeds limit (only check, don't show modal yet - that happens on submit)
            if (selectedFiles.length > MAX_RESUMES_PER_UPLOAD) {
                // Just update the list, modal will show when they try to continue
                proceedWithAllFiles = false;
            }

            updateResumesList();
        });

        // Drag and drop
        resumeDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            resumeDropzone.style.borderColor = '#2563eb';
            resumeDropzone.style.background = '#dbeafe';
        });

        resumeDropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            resumeDropzone.style.borderColor = '#3b82f6';
            resumeDropzone.style.background = '#f0f9ff';
        });

        resumeDropzone.addEventListener('drop', async (e) => {
            e.preventDefault();
            resumeDropzone.style.borderColor = '#3b82f6';
            resumeDropzone.style.background = '#f0f9ff';

            const newFiles = Array.from(e.dataTransfer.files);

            // Validate files for locks BEFORE adding them
            for (let file of newFiles) {
                try {
                    // Try to read first 1KB to check if file is accessible
                    await file.slice(0, 1024).arrayBuffer();
                } catch (err) {
                    // File is locked!
                    alert(`‚ö†Ô∏è Cannot add "${file.name}"\n\nThis file is currently open in another program. Please close it first, then try adding it again.`);
                    return; // Don't add any files from this drop
                }
            }

            // All files are accessible - add them
            newFiles.forEach(file => {
                if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                }
            });

            // Check if exceeds limit
            if (selectedFiles.length > MAX_RESUMES_PER_UPLOAD) {
                proceedWithAllFiles = false;
            }

            updateResumesList();
        });
    }

    function updateResumesList() {
        if (!selectedResumesList) return;

        if (selectedFiles.length === 0) {
            selectedResumesList.innerHTML = '';
            updateContinueButton(false);
            updateContinueButtonText('Upload Resumes');
            return;
        }

        selectedResumesList.innerHTML = `
        <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 16px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <h4 style="color: #1e40af; margin: 0; font-size: 16px; font-weight: 600;">
                    <i data-lucide="file-check" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;"></i>
                    ${selectedFiles.length} file(s) ready to upload
                </h4>
                <button type="button" onclick="removeAllFiles()" style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer;">
                    <i data-lucide="trash-2" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i>
                    Remove All
                </button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                ${selectedFiles.map((file, index) => `
                    <div style="display: flex; align-items: center; justify-content: space-between; background: white; padding: 10px 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <span style="color: #1f2937; font-size: 14px; flex: 1;">${file.name}</span>
                        <button type="button" onclick="removeFile(${index})" style="background: none; border: none; color: #dc2626; cursor: pointer; padding: 4px;">
                            <i data-lucide="x" style="width: 18px; height: 18px;"></i>
                        </button>
                    </div>
                `).join('')}
            </div>
        </div>
    `;

        // Re-initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Update file input with selected files
        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(file => dataTransfer.items.add(file));
        resumeFiles.files = dataTransfer.files;

        // Enable sticky button and update text
        updateContinueButton(true);
        updateContinueButtonText('Continue to Run Analysis ‚Üí');

        // Update button handler to submit the form
        updateContinueButtonHandler('resumeUploadForm');
    }

    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        updateResumesList();
    }

    // Show resume upload overlay (make it global so workflow_bottom_bar can call it)
    window.showResumeUploadOverlay = function() {
        const overlay = document.getElementById('resumeUploadOverlay');
        const countText = document.getElementById('resumeUploadCount');
        const largeUploadWarning = document.getElementById('largeUploadWarning');

        if (overlay && countText) {
            const fileCount = selectedFiles.length;
            if (fileCount > 0) {
                countText.textContent = `Processing ${fileCount} resume${fileCount !== 1 ? 's' : ''}...`;

                // Show patience message for large uploads (70+)
                if (largeUploadWarning && fileCount >= 70) {
                    largeUploadWarning.style.display = 'block';
                }
            }
            overlay.style.display = 'flex';
        }
    }

    // Resume limit modal functions
    function showResumeLimitModal(fileCount, maxLimit) {
        const modal = document.getElementById('resumeLimitModal');
        const message = document.getElementById('resumeLimitMessage');
        const fullCount = document.getElementById('fullCount');

        if (modal && message) {
            message.textContent = `You've selected ${fileCount} resumes, but our recommended limit is ${maxLimit} per upload for optimal processing.`;
            fullCount.textContent = fileCount;
            modal.style.display = 'flex';
        }
    }

    function closeResumeLimitModal() {
        const modal = document.getElementById('resumeLimitModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    window.removeAllFiles = function() {
        selectedFiles = [];
        updateResumesList();
    }

    function tryAnywayWithWarning() {
        // Set flag to allow all files
        proceedWithAllFiles = true;
        // Mark that user chose to override the limit (for analytics)
        document.getElementById('overrideLimitField').value = 'true';
        closeResumeLimitModal();
        // Now actually submit with all files
        document.getElementById('resumeUploadForm').submit();
    }

    // Intercept form submission to check limit
    if (document.getElementById('resumeUploadForm')) {
        document.getElementById('resumeUploadForm').addEventListener('submit', async function (e) {
            // STEP 1: Check if any files are locked (open in another program)
            const fileInput = document.getElementById('resumeFiles');
            if (fileInput && fileInput.files) {
                for (let i = 0; i < fileInput.files.length; i++) {
                    const file = fileInput.files[i];
                    try {
                        // Attempt to read the first 1KB of the file
                        // If the OS has a lock on it, this will throw an error immediately
                        await file.slice(0, 1024).arrayBuffer();
                    } catch (err) {
                        e.preventDefault(); // Stop the form from submitting
                        alert(`Wait! The file "${file.name}" is currently open in another program.\n\nPlease close the file on your desktop and try again to begin your Full Ranking.`);
                        return false;
                    }
                }
            }

            // STEP 2: Check resume upload limit (existing validation)
            // Only check if we haven't already approved all files
            if (!proceedWithAllFiles && selectedFiles.length > MAX_RESUMES_PER_UPLOAD) {
                e.preventDefault();
                showResumeLimitModal(selectedFiles.length, MAX_RESUMES_PER_UPLOAD);
                return false;
            }
            // Otherwise let it submit normally (showResumeUploadOverlay will be called by workflow_bottom_bar)
        });
    }

    // Clear session function
    function clearSession() {
        if (confirm('This will clear the uploaded JD and extracted criteria. Continue?')) {
            fetch('{{ url_for("analysis.clear_session") }}', {
                method: 'POST'
            }).then(() => window.location.reload());
        }
    }

}); // End DOMContentLoaded
</script>

<!-- Include Bottom Bar -->
{% if step_name == 'jd' %}
{% if jd_data %}
{% set show_back_button = False %}
{% set continue_url = url_for('analysis.review_criteria') %}
{% set continue_text = 'Continue to Criteria' %}
{% set continue_disabled = False %}
{% else %}
{% set show_back_button = False %}
{% set continue_disabled = True %}
{% set continue_text = 'Extract Criteria with AI' %}
{% set continue_is_submit = True %}
{% set submit_form_id = 'jdForm' %}
{% endif %}
{% elif step_name == 'resumes' %}
{% set show_back_button = True %}
{% set back_url = url_for('analysis.review_criteria') %}
{% if uploaded_resumes %}
{% set continue_url = url_for('analysis.run_analysis_route') %}
{% set continue_text = 'Continue to Run Analysis ‚Üí' %}
{% set continue_disabled = False %}
{% else %}
{% set continue_disabled = True %}
{% set continue_text = 'Upload Resumes' %}
{% set continue_is_submit = True %}
{% set submit_form_id = 'resumeUploadForm' %}
{% endif %}
{% endif %}
{% include 'workflow_bottom_bar.html' %}

{% endblock %}