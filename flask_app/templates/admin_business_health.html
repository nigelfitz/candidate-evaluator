{% extends "admin_base.html" %}

{% block title %}Business Health - Admin Panel{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block extra_styles %}
.profit-card {
background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
color: white;
padding: 35px;
border-radius: 15px;
margin-bottom: 30px;
box-shadow: 0 10px 30px rgba(17, 153, 142, 0.3);
}
.profit-card h3 {
margin: 0 0 25px 0;
font-size: 1.5rem;
font-weight: 600;
color: white;
}
.profit-card small {
color: rgba(255, 255, 255, 0.9);
font-size: 0.95rem;
display: block;
margin-bottom: 8px;
}
.profit-value { font-size: 3rem; font-weight: bold; margin: 15px 0; color: white; }
.profit-breakdown { background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; margin-top: 20px; }
.profit-breakdown strong { color: white; font-size: 1.1rem; }
.profit-breakdown div { margin: 8px 0; font-size: 1rem; color: white; }
.setting-group { margin-bottom: 25px; }
.setting-group label { font-weight: 600; color: #1a1a1a; margin-bottom: 8px; display: block; }
.setting-description { color: #666; font-size: 0.9rem; margin-top: 6px; }
.form-control { padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; }
.form-control:focus { border-color: #667eea; box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25); }
.admin-tabs { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); padding: 15px 30px;
margin-bottom: 20px; }
.admin-tabs a { color: #666; text-decoration: none; padding: 12px 24px; display: inline-block; border-bottom: 3px solid
transparent; font-weight: 500; transition: all 0.3s; position: relative; }
.admin-tabs a:hover { color: #667eea; }
.admin-tabs a.active { color: #667eea; border-bottom-color: #667eea; }
/* Finance Menu Container */
.finance-menu-container { display: inline-block; position: relative; }
/* System Settings Menu Container */
.system-settings-menu-container { display: inline-block; position: relative; }
/* System Settings Dropdown */
.system-settings-dropdown { display: none; position: absolute; background: white; border-radius: 8px; box-shadow: 0 4px
12px rgba(0,0,0,0.15); min-width: 200px; z-index: 10000; top: 100%; left: 0; border: 1px solid #e0e0e0; margin-top: 0;
padding-top: 8px; }
.system-settings-dropdown a { display: block !important; padding: 12px 20px !important; border-bottom: 1px solid #f0f0f0
!important; font-size: 0.95rem !important; position: relative !important; color: #666 !important; text-decoration: none
!important; }
.system-settings-dropdown a:last-child { border-bottom: none !important; }
.system-settings-dropdown a:hover { background: #f8f9fa !important; color: #667eea !important; }
/* Finance Dropdown */
.finance-dropdown {
display: none;
position: absolute;
background: white;
border-radius: 8px;
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
min-width: 200px;
z-index: 10000;
top: 100%;
left: 0;
border: 1px solid #e0e0e0;
margin-top: 0;
padding-top: 8px;
}
.finance-dropdown a {
display: block !important;
padding: 12px 20px !important;
border-bottom: 1px solid #f0f0f0 !important;
font-size: 0.95rem !important;
position: relative !important;
color: #666 !important;
text-decoration: none !important;
}
.finance-dropdown a:last-child { border-bottom: none !important; }
.finance-dropdown a:hover { background: #f8f9fa !important; color: #667eea !important; }
.logout-btn { position: fixed; top: 20px; right: 20px; z-index: 1000; }
.section-title { font-size: 1.4rem; font-weight: 700; color: #1a1a1a; margin-bottom: 20px; padding-bottom: 10px;
border-bottom: 3px solid #667eea; }
{% endblock %}

{% block content %}
<h1 class="text-center mb-4">üíö Job Pricing Health Calculator</h1>

{% if message %}
<div class="alert alert-success">
    ‚úÖ {{ message }}
</div>
{% endif %}

<!-- Profit Margin Dashboard -->
<div class="profit-card">
    <h3>üí∞ Job Profitability Calculator</h3>
    <div class="row">
        <div class="col-md-4">
            <small id="scenarioLabel">Analysis Cost</small>
            <div class="profit-value" id="analysisCost">$0.85</div>
            <div style="font-size: 0.9rem; margin-top: 5px; opacity: 0.95;" id="scenarioDetails">50 candidates √ó 20
                criteria</div>
        </div>
        <div class="col-md-4">
            <small>Revenue (Standard Tier)</small>
            <div class="profit-value" id="revenueAmount">$10.00</div>
        </div>
        <div class="col-md-4">
            <small>Profit Margin</small>
            <div class="profit-value" id="profitMargin">92%</div>
        </div>
    </div>
    <div class="profit-breakdown">
        <strong>Cost Breakdown:</strong>
        <div id="rankerCost">‚Ä¢ RANKER: $0.73 (1000 scoring calls)</div>
        <div id="insightCost">‚Ä¢ INSIGHT: $0.12 (5 deep insights)</div>
        <div id="profitAmount">‚Ä¢ Profit: $9.15</div>
    </div>
</div>

<!-- Document Length Scenario Selector -->
<div class="card p-4 mb-4" style="background: #f8f9fa; border-left: 4px solid #667eea;">
    <h4 class="mb-3">üìÑ Document Length Scenario</h4>
    <p class="text-muted mb-3">
        <strong>Important:</strong> Your maximum character limits are set in AI Settings, but actual documents are often
        shorter. Select a scenario:
    </p>
    <div class="btn-group w-100" role="group">
        <input type="radio" class="btn-check" name="lengthScenario" id="scenario50" value="50" checked
            onclick="updateCostEstimate()">
        <label class="btn btn-outline-primary" for="scenario50">
            <strong>Scenario A</strong><br>
            <small>Uses 50% of char limits</small>
        </label>

        <input type="radio" class="btn-check" name="lengthScenario" id="scenario75" value="75"
            onclick="updateCostEstimate()">
        <label class="btn btn-outline-primary" for="scenario75">
            <strong>Scenario B</strong><br>
            <small>Uses 75% of char limits</small>
        </label>

        <input type="radio" class="btn-check" name="lengthScenario" id="scenario100" value="100"
            onclick="updateCostEstimate()">
        <label class="btn btn-outline-primary" for="scenario100">
            <strong>Scenario C</strong><br>
            <small>Uses 100% of char limits</small>
        </label>
    </div>
    <div class="mt-3 text-muted" style="font-size: 0.9rem;">
        <strong>Current Max Limits:</strong> JD: <span id="displayJdLimit">{{
            settings.text_processing.jd_text_chars.value }}</span> chars, Resume: <span id="displayCandidateLimit">{{
            settings.text_processing.candidate_text_chars.value }}</span> chars &nbsp;|&nbsp; <strong>Scenario
            Settings:</strong> JD: <span id="scenarioJdChars">-</span> chars, Resume: <span
            id="scenarioCandidateChars">-</span> chars
    </div>
</div>

<!-- Calculator Settings Form -->
<form method="POST" action="{{ url_for('admin.admin_save_business_health') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <h2 class="section-title">‚öôÔ∏è Calculator Settings</h2>

    <p class="alert alert-info">
        <strong>‚ÑπÔ∏è Calculator Assumptions:</strong> These settings control the Job Profitability Calculator above.
        Adjust to test different business assumptions and volumes.
    </p>

    <div class="setting-group">
        <label for="avg_candidates">Average Candidates per Job</label>
        <input type="number" class="form-control" id="avg_candidates" name="avg_candidates"
            value="{{ settings.calculator_settings.avg_candidates_per_job.value }}" min="10" max="200"
            oninput="updateCostEstimate()">
        <div class="setting-description">
            Typical volume: 50. More candidates = more RANKER calls = higher cost.
        </div>
    </div>

    <div class="setting-group">
        <label for="avg_criteria">Average Criteria per Job</label>
        <input type="number" class="form-control" id="avg_criteria" name="avg_criteria"
            value="{{ settings.calculator_settings.avg_criteria_per_job.value }}" min="5" max="40"
            oninput="updateCostEstimate()">
        <div class="setting-description">
            Typical JD: 20 criteria. Formula: <strong>RANKER calls = candidates √ó criteria</strong>
        </div>
    </div>

    <div class="setting-group">
        <label for="insights_generated">Insights Generated (Standard Tier)</label>
        <input type="number" class="form-control" id="insights_generated" name="insights_generated"
            value="{{ settings.calculator_settings.insights_generated.value }}" min="3" max="10"
            oninput="updateCostEstimate()">
        <div class="setting-description">
            Standard tier includes 5 insights. Each costs ~$0.03 with gpt-4o.
        </div>
    </div>

    <div class="setting-group">
        <label>Standard Tier Revenue ($)</label>
        <div class="alert alert-info" style="margin-top: 10px;">
            <strong>Current Price: $<span id="standard_revenue">{{ pricing.standard_tier_price.value
                    }}</span></strong><br>
            <small>Revenue is managed on the <a href="{{ url_for('admin.admin_pricing') }}" style="color: #0066cc;">Pricing &
                    Revenue</a> page (Single Source of Truth)</small>
        </div>
    </div>

    <hr style="margin: 40px 0;">

    <h2 class="section-title">üìê Token Estimation Formulas</h2>

    <div class="alert alert-info">
        <p><strong>RANKER Input Tokens:</strong> (JD chars + Candidate chars) √∑ 4</p>
        <p><strong>INSIGHT Input Tokens:</strong> (JD chars + Candidate chars + (Criteria √ó 500)) √∑ 4</p>
        <p class="mb-0"><small>Based on ~4 characters per token average. INSIGHT gets extra evidence context.</small>
        </p>
    </div>

    <div id="liveCalculation" class="alert alert-secondary" style="margin-top: 20px;">
        <!-- JavaScript will populate this with live math -->
    </div>

    <div class="text-center" style="margin-top: 40px;">
        <button type="submit" class="btn btn-save">üíæ Save Calculator Settings</button>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
    // Read text processing settings from hidden inputs (passed from backend)
    const candidateTextCharsMax = {{ settings.text_processing.candidate_text_chars.value }};
    const jdTextCharsMax = {{ settings.text_processing.jd_text_chars.value }};
    const rankerModel = "{{ settings.ranker_model.value }}";
    const insightModel = "{{ settings.insight_model.value }}";
    const rankerMaxTokens = {{ settings.advanced_api_settings.ranker_max_tokens.value }};
    const insightMaxTokens = {{ settings.advanced_api_settings.insight_max_tokens.value }};

    // Update display of character limits
    document.getElementById('displayJdLimit').textContent = jdTextCharsMax.toLocaleString();
    document.getElementById('displayCandidateLimit').textContent = candidateTextCharsMax.toLocaleString();

    function updateCostEstimate() {
        // Read calculator scenario settings
        const numCandidates = parseInt(document.getElementById('avg_candidates').value);
        const numCriteria = parseInt(document.getElementById('avg_criteria').value);
        const numInsights = parseInt(document.getElementById('insights_generated').value);
        const revenue = parseFloat(document.getElementById('standard_revenue').textContent);

        // Get document length scenario multiplier
        const scenarioMultiplier = parseInt(document.querySelector('input[name="lengthScenario"]:checked').value) / 100;
        const jdTextChars = Math.round(jdTextCharsMax * scenarioMultiplier);
        const candidateTextChars = Math.round(candidateTextCharsMax * scenarioMultiplier);

        // Update scenario settings display
        document.getElementById('scenarioJdChars').textContent = jdTextChars.toLocaleString();
        document.getElementById('scenarioCandidateChars').textContent = candidateTextChars.toLocaleString();

        // DYNAMIC TOKEN ESTIMATION (VISIBLE FORMULAS)
        const rankerInputTokens = Math.ceil((jdTextChars + candidateTextChars) / 4);
        const insightInputTokens = Math.ceil((jdTextChars + candidateTextChars + (numCriteria * 500)) / 4);

        // Model pricing ($ per million tokens) - Dec 2025 rates
        const costs = {
            'gpt-4o': { input: 2.5, output: 10.0 },
            'gpt-4o-mini': { input: 0.15, output: 0.6 },
            'gpt-4-turbo': { input: 10.0, output: 30.0 },
            'gpt-4': { input: 30.0, output: 60.0 }
        };

        // Calculate ranker costs
        const rankerCalls = numCandidates * numCriteria;
        const rankerOutputTokens = Math.ceil(rankerMaxTokens * 0.5);

        const rankerInputCost = (rankerInputTokens * rankerCalls / 1000000) * costs[rankerModel].input;
        const rankerOutputCost = (rankerOutputTokens * rankerCalls / 1000000) * costs[rankerModel].output;
        const rankerTotalCost = rankerInputCost + rankerOutputCost;

        // Calculate insight costs
        const insightOutputTokens = Math.ceil(insightMaxTokens * 0.5);

        const insightInputCost = (insightInputTokens * numInsights / 1000000) * costs[insightModel].input;
        const insightOutputCost = (insightOutputTokens * numInsights / 1000000) * costs[insightModel].output;
        const insightTotalCost = insightInputCost + insightOutputCost;

        // Total costs
        const totalCost = rankerTotalCost + insightTotalCost;
        const profit = revenue - totalCost;
        const profitMargin = (profit / revenue) * 100;

        // Get scenario name for display
        const scenarioRadios = document.getElementsByName('lengthScenario');
        let scenarioName = 'Maximum';
        let scenarioPercent = '100%';
        for (let radio of scenarioRadios) {
            if (radio.checked) {
                if (radio.value === '100') {
                    scenarioName = 'Maximum Length';
                    scenarioPercent = '100%';
                } else if (radio.value === '75') {
                    scenarioName = 'Typical Length';
                    scenarioPercent = '75%';
                } else if (radio.value === '50') {
                    scenarioName = 'Short Documents';
                    scenarioPercent = '50%';
                }
                break;
            }
        }

        // Update display
        document.getElementById('scenarioLabel').textContent = `Analysis Cost (${scenarioName})`;
        document.getElementById('scenarioDetails').textContent = `${numCandidates} candidates √ó ${numCriteria} criteria at ${scenarioPercent} of max document length`;
        document.getElementById('analysisCost').textContent = '$' + totalCost.toFixed(2);
        document.getElementById('revenueAmount').textContent = '$' + revenue.toFixed(2);
        document.getElementById('rankerCost').textContent = '‚Ä¢ RANKER: $' + rankerTotalCost.toFixed(2) + ' (' + rankerCalls + ' scoring calls)';
        document.getElementById('insightCost').textContent = '‚Ä¢ INSIGHT: $' + insightTotalCost.toFixed(2) + ' (' + numInsights + ' deep insights)';
        document.getElementById('profitAmount').textContent = '‚Ä¢ Profit: $' + profit.toFixed(2);
        document.getElementById('profitMargin').textContent = profitMargin.toFixed(0) + '%';

        // Color code profit margin
        const profitCard = document.querySelector('.profit-card');
        if (profitMargin < 50) {
            profitCard.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
        } else if (profitMargin < 70) {
            profitCard.style.background = 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)';
        } else {
            profitCard.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
        }

        // Update live calculation display with visible math
        const liveCalcDiv = document.getElementById('liveCalculation');
        if (liveCalcDiv) {
            liveCalcDiv.innerHTML = `
                    <h5><i class="fas fa-chart-line"></i> Live Calculation Breakdown</h5>
                    
                    <p><strong>Text Limits:</strong> JD ${jdTextChars.toLocaleString()} chars + Candidate ${candidateTextChars.toLocaleString()} chars = ${(jdTextChars + candidateTextChars).toLocaleString()} total chars</p>
                    
                    <p><strong>Token Estimates:</strong></p>
                    <ul>
                        <li><strong>RANKER input:</strong> (${jdTextChars.toLocaleString()} + ${candidateTextChars.toLocaleString()}) √∑ 4 = <strong>${rankerInputTokens.toLocaleString()} tokens</strong></li>
                        <li><strong>RANKER output:</strong> ${rankerMaxTokens} max √ó 0.5 = <strong>${rankerOutputTokens.toLocaleString()} tokens</strong> (50% utilization estimate)</li>
                        <li><strong>INSIGHT input:</strong> (${jdTextChars.toLocaleString()} + ${candidateTextChars.toLocaleString()} + (${numCriteria} √ó 500)) √∑ 4 = <strong>${insightInputTokens.toLocaleString()} tokens</strong></li>
                        <li><strong>INSIGHT output:</strong> ${insightMaxTokens} max √ó 0.5 = <strong>${insightOutputTokens.toLocaleString()} tokens</strong></li>
                    </ul>
                    
                    <p><strong>RANKER Costs (${rankerModel}):</strong></p>
                    <ul>
                        <li>Calls: ${numCandidates} candidates √ó ${numCriteria} criteria = <strong>${rankerCalls.toLocaleString()} calls</strong></li>
                        <li>Input: (${rankerInputTokens.toLocaleString()} √ó ${rankerCalls.toLocaleString()}) √∑ 1M √ó $${costs[rankerModel].input} = <strong>$${rankerInputCost.toFixed(4)}</strong></li>
                        <li>Output: (${rankerOutputTokens.toLocaleString()} √ó ${rankerCalls.toLocaleString()}) √∑ 1M √ó $${costs[rankerModel].output} = <strong>$${rankerOutputCost.toFixed(4)}</strong></li>
                        <li><strong>RANKER Total: $${rankerTotalCost.toFixed(2)}</strong></li>
                    </ul>
                    
                    <p><strong>INSIGHT Costs (${insightModel}):</strong></p>
                    <ul>
                        <li>Insights: <strong>${numInsights}</strong></li>
                        <li>Input: (${insightInputTokens.toLocaleString()} √ó ${numInsights}) √∑ 1M √ó $${costs[insightModel].input} = <strong>$${insightInputCost.toFixed(4)}</strong></li>
                        <li>Output: (${insightOutputTokens.toLocaleString()} √ó ${numInsights}) √∑ 1M √ó $${costs[insightModel].output} = <strong>$${insightOutputCost.toFixed(4)}</strong></li>
                        <li><strong>INSIGHT Total: $${insightTotalCost.toFixed(2)}</strong></li>
                    </ul>
                    
                    <hr>
                    
                    <p class="mb-0"><strong>Bottom Line:</strong></p>
                    <ul class="mb-0">
                        <li>Total Cost: <strong>$${totalCost.toFixed(2)}</strong></li>
                        <li>Revenue: <strong>$${revenue.toFixed(2)}</strong></li>
                        <li>Profit: <strong>$${profit.toFixed(2)}</strong> (<strong>${profitMargin.toFixed(1)}%</strong> margin)</li>
                    </ul>
                `;
        }
    }

    // Initialize on page load
    updateCostEstimate();

    // Finance dropdown hover functionality
    const financeContainer = document.querySelector('.finance-menu-container');
    const dropdown = document.querySelector('.finance-dropdown');
    if (financeContainer && dropdown) {
        financeContainer.addEventListener('mouseenter', () => {
            dropdown.style.display = 'block';
        });
        financeContainer.addEventListener('mouseleave', () => {
            dropdown.style.display = 'none';
        });
    }

    // System Settings dropdown hover functionality
    const systemContainer = document.querySelector('.system-settings-menu-container');
    const systemDropdown = document.querySelector('.system-settings-dropdown');
    if (systemContainer && systemDropdown) {
        systemContainer.addEventListener('mouseenter', () => {
            systemDropdown.style.display = 'block';
        });
        systemContainer.addEventListener('mouseleave', () => {
            systemDropdown.style.display = 'none';
        });
    }
</script>
{% endblock %}
