{% extends "base.html" %}

{% block title %}Account - Candidate Evaluator{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 40px 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="color: #1f2937; margin: 0;">üí≥ Account Balance</h1>
        <a href="{{ url_for('payments.wallet') }}" class="btn btn-primary">
            ‚ûï Add Funds
        </a>
    </div>
    
    <!-- Current Balance Card -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                padding: 40px; 
                border-radius: 16px; 
                box-shadow: 0 8px 16px rgba(0,0,0,0.15); 
                margin-bottom: 40px;
                color: white;">
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 30px; align-items: center;">
            <div>
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; letter-spacing: 0.5px;">
                    AVAILABLE BALANCE
                </div>
                <div style="font-size: 48px; font-weight: 700; margin-bottom: 5px;">
                    ${{ "%.2f"|format(current_user.balance_usd) }}
                </div>
                <div style="font-size: 14px; opacity: 0.85;">
                    Account: {{ current_user.email }}
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 32px; margin-bottom: 10px;">üí∞</div>
                <a href="{{ url_for('dashboard.job_history') }}" 
                   style="display: inline-block; 
                          padding: 8px 16px; 
                          background: rgba(255,255,255,0.2); 
                          border-radius: 8px; 
                          color: white; 
                          text-decoration: none; 
                          font-size: 13px;
                          backdrop-filter: blur(10px);"
                   onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    üìã View Job History
                </a>
            </div>
        </div>
    </div>
    
    <!-- Transaction History -->
    <h2 style="color: #1f2937; margin-bottom: 20px; font-size: 24px;">Transaction History</h2>
    
    {% if transactions %}
    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                    <th style="padding: 16px; text-align: left; color: #6b7280; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Date</th>
                    <th style="padding: 16px; text-align: left; color: #6b7280; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Type</th>
                    <th style="padding: 16px; text-align: left; color: #6b7280; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Description</th>
                    <th style="padding: 16px; text-align: right; color: #6b7280; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Amount</th>
                    <th style="padding: 16px; text-align: right; color: #6b7280; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Balance</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in transactions %}
                <tr style="border-bottom: 1px solid #f3f4f6; transition: background 0.2s;"
                    onmouseover="this.style.background='#f9fafb'"
                    onmouseout="this.style.background='white'">
                    <td style="padding: 16px; color: #1f2937;" class="local-time" data-utc="{{ transaction.created_at|to_local_time }}">
                        {{ transaction.created_at.strftime('%b %d, %Y %I:%M %p') }}
                    </td>
                    <td style="padding: 16px;">
                        {% if transaction.transaction_type == 'credit' %}
                            <span style="background: #10b981; color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; letter-spacing: 0.3px;">
                                CREDIT
                            </span>
                        {% else %}
                            <span style="background: #f3f4f6; color: #374151; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; letter-spacing: 0.3px;">
                                DEBIT
                            </span>
                        {% endif %}
                    </td>
                    <td style="padding: 16px;">
                        {% if transaction.analysis_id and transaction.analysis_id in existing_analyses %}
                            {# Analysis exists - show clickable link with Job# #}
                            {% set analysis = transactions_analyses.get(transaction.analysis_id) %}
                            <a href="{{ url_for('analysis.results', analysis_id=transaction.analysis_id) }}" 
                               style="color: #1f77b4; text-decoration: none; font-weight: 500; display: block; margin-bottom: 4px;"
                               onmouseover="this.style.textDecoration='underline'"
                               onmouseout="this.style.textDecoration='none'">
                                Job #{{ "%04d"|format(transaction.analysis_id) }}: {{ analysis.job_title if analysis else 'Analysis' }}
                            </a>
                            {% if analysis %}
                                <div style="color: #9ca3af; font-size: 13px;">
                                    {{ analysis.num_candidates }} candidates ‚Ä¢ {{ analysis.num_criteria }} criteria
                                </div>
                            {% endif %}
                        {% elif transaction.analysis_deleted_at %}
                            {# Analysis was deleted - show job description with deletion timestamp in tooltip #}
                            <span style="color: #6b7280; cursor: help; border-bottom: 1px dotted #9ca3af;"
                                  title="Job Deleted on: {{ transaction.analysis_deleted_at.strftime('%b %d, %Y at %I:%M %p UTC') }}">
                                {{ transaction.description }} <span style="color: #dc2626; font-size: 11px;">(Deleted)</span>
                            </span>
                        {% else %}
                            {# No analysis (e.g., credit purchase) #}
                            <span style="color: #1f2937;">{{ transaction.description }}</span>
                        {% endif %}
                    </td>
                    <td style="padding: 16px; text-align: right;">
                        {% if transaction.transaction_type == 'credit' and transaction.stripe_amount_cents and transaction.stripe_amount_cents > 0 %}
                            {# Show Stripe payment amount for credit purchases #}
                            <span style="color: #059669; font-weight: 700; font-size: 15px;">+${{ "%.2f"|format(transaction.stripe_amount_cents / 100) }}</span>
                        {% elif transaction.amount_usd > 0 %}
                            <span style="color: #059669; font-weight: 700; font-size: 15px;">+${{ "%.2f"|format(transaction.amount_usd) }}</span>
                        {% else %}
                            <span style="color: #dc2626; font-weight: 700; font-size: 15px;">-${{ "%.2f"|format(transaction.amount_usd|abs) }}</span>
                        {% endif %}
                    </td>
                    <td style="padding: 16px; text-align: right; color: #1f2937; font-weight: 700; font-size: 15px;">
                        ${{ "%.2f"|format(balances[loop.index0]) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="font-size: 48px; margin-bottom: 20px;">üìä</div>
        <h2 style="color: #6b7280; margin-bottom: 10px;">No transactions yet</h2>
        <p style="color: #9ca3af; margin-bottom: 30px;">Add funds to start analyzing candidates</p>
        <a href="{{ url_for('payments.wallet') }}" class="btn btn-primary">
            Add Funds
        </a>
    </div>
    {% endif %}
    
    <div style="text-align: center; margin-top: 40px;">
        <a href="{{ url_for('dashboard.dashboard') }}" 
           style="color: #1f77b4; text-decoration: none; font-weight: 500;"
           onmouseover="this.style.textDecoration='underline'"
           onmouseout="this.style.textDecoration='none'">
            ‚Üê Back to Dashboard
        </a>
        <h2 style="color: #dc2626; margin: 60px 0 15px 0; font-size: 20px; padding-top: 40px; border-top: 2px solid #e5e7eb;">‚ö†Ô∏è Danger Zone</h2>
        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="color: #dc2626; font-weight: 600; margin-bottom: 5px;">Delete Account</div>
                    <div style="color: #6b7280; font-size: 14px;">
                        Permanently delete your account and all associated data. This action cannot be undone.
                    </div>
                </div>
                <button onclick="showDeleteConfirmation()" 
                        style="background: #dc2626; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;"
                        onmouseover="this.style.background='#b91c1c'"
                        onmouseout="this.style.background='#dc2626'">
                    üóëÔ∏è Delete Account
                </button>
            </div>
        </div>
    </div>
    
    <!-- Delete Account Confirmation Modal -->
    <div id="deleteAccountModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                <div style="background: #fee2e2; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 15px;">
                    ‚ö†Ô∏è
                </div>
                <h3 style="margin: 0; color: #1f2937; font-size: 20px;">Delete Account?</h3>
            </div>
            
            <p style="color: #6b7280; margin-bottom: 20px; line-height: 1.6;">
                This will <strong style="color: #dc2626;">permanently delete</strong> your account, including:
            </p>
            <ul style="color: #6b7280; margin-bottom: 20px; padding-left: 25px;">
                <li>Your account balance (${{ "%.2f"|format(current_user.balance_usd) }})</li>
                <li>All job analyses and results</li>
                <li>Transaction history</li>
                <li>All uploaded candidate files</li>
            </ul>
            <p style="color: #dc2626; font-weight: 600; margin-bottom: 20px;">
                ‚ö†Ô∏è This action cannot be undone.
            </p>
            
            <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 8px;">
                    Type <strong>DELETE</strong> to confirm:
                </label>
                <input type="text" 
                       id="deleteConfirmInput" 
                       placeholder="Type DELETE in capital letters"
                       style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="hideDeleteConfirmation()" 
                        style="flex: 1; background: #f3f4f6; color: #374151; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 500;"
                        onmouseover="this.style.background='#e5e7eb'"
                        onmouseout="this.style.background='#f3f4f6'">
                    Cancel
                </button>
                <form method="POST" action="{{ url_for('dashboard.delete_account') }}" style="flex: 1; margin: 0;" id="deleteAccountForm">
                    <button type="button"
                            onclick="submitDeleteAccount()"
                            id="confirmDeleteBtn"
                            style="width: 100%; background: #dc2626; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 500;"
                            onmouseover="this.style.background='#b91c1c'"
                            onmouseout="this.style.background='#dc2626'"
                            disabled>
                        Delete My Account
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Convert UTC timestamps to user's local timezone
document.addEventListener('DOMContentLoaded', function() {
    // Convert transaction timestamps
    document.querySelectorAll('.local-time:not(.deleted-analysis-tooltip)').forEach(function(elem) {
        const utcTime = elem.getAttribute('data-utc');
        if (utcTime) {
            const date = new Date(utcTime);
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            elem.textContent = date.toLocaleString('en-US', options);
        }
    });
    
    // Convert deleted analysis tooltips
    document.querySelectorAll('.deleted-analysis-tooltip').forEach(function(elem) {
        const utcTime = elem.getAttribute('data-utc');
        if (utcTime) {
            const date = new Date(utcTime);
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            const localTime = date.toLocaleString('en-US', options);
            elem.setAttribute('title', 'This analysis was deleted on ' + localTime);
        }
    });
});
</script>
{% endblock %}
