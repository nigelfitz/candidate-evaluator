{% extends "base.html" %}

{% block title %}Account - Candidate Evaluator{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 40px 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="color: #1f2937; margin: 0;">üí≥ Account Balance</h1>
        <a href="{{ url_for('payments.buy_credits') }}" class="btn btn-primary">
            ‚ûï Add Funds
        </a>
    </div>
    
    <!-- Current Balance Card -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                padding: 40px; 
                border-radius: 16px; 
                box-shadow: 0 8px 16px rgba(0,0,0,0.15); 
                margin-bottom: 40px;
                color: white;">
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 30px; align-items: center;">
            <div>
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; letter-spacing: 0.5px;">
                    AVAILABLE BALANCE
                </div>
                <div style="font-size: 48px; font-weight: 700; margin-bottom: 5px;">
                    ${{ "%.2f"|format(current_user.balance_usd) }}
                </div>
                <div style="font-size: 14px; opacity: 0.85;">
                    Account: {{ current_user.email }}
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 32px; margin-bottom: 10px;">üí∞</div>
                <a href="{{ url_for('job_history') }}" 
                   style="display: inline-block; 
                          padding: 8px 16px; 
                          background: rgba(255,255,255,0.2); 
                          border-radius: 8px; 
                          color: white; 
                          text-decoration: none; 
                          font-size: 13px;
                          backdrop-filter: blur(10px);"
                   onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    üìã View Job History
                </a>
            </div>
        </div>
    </div>
    
    <!-- Summary Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #10b981;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px; font-weight: 500;">TOTAL ADDED</div>
                    <div style="color: #1f2937; font-size: 32px; font-weight: 700;">
                        ${{ "%.2f"|format(transactions|selectattr('transaction_type', 'equalto', 'credit')|map(attribute='amount_usd')|sum) }}
                    </div>
                </div>
                <div style="background: #d1fae5; padding: 12px; border-radius: 10px; color: #059669; font-size: 24px;">
                    ‚ûï
                </div>
            </div>
        </div>
        
        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #dc2626;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px; font-weight: 500;">TOTAL SPENT</div>
                    <div style="color: #1f2937; font-size: 32px; font-weight: 700;">
                        ${{ "%.2f"|format((transactions|selectattr('transaction_type', 'equalto', 'debit')|map(attribute='amount_usd')|sum)|abs) }}
                    </div>
                </div>
                <div style="background: #fee2e2; padding: 12px; border-radius: 10px; color: #dc2626; font-size: 24px;">
                    üí∏
                </div>
            </div>
        </div>
        
        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #1f77b4;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px; font-weight: 500;">TRANSACTIONS</div>
                    <div style="color: #1f2937; font-size: 32px; font-weight: 700;">
                        {{ transactions|length }}
                    </div>
                </div>
                <div style="background: #dbeafe; padding: 12px; border-radius: 10px; color: #1f77b4; font-size: 24px;">
                    üìä
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transaction History -->
    <h2 style="color: #1f2937; margin-bottom: 20px; font-size: 24px;">Transaction History</h2>
    
    {% if transactions %}
    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                    <th style="padding: 16px; text-align: left; color: #6b7280; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Date</th>
                    <th style="padding: 16px; text-align: left; color: #6b7280; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Type</th>
                    <th style="padding: 16px; text-align: left; color: #6b7280; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Description</th>
                    <th style="padding: 16px; text-align: right; color: #6b7280; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Amount</th>
                    <th style="padding: 16px; text-align: right; color: #6b7280; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Balance</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in transactions %}
                <tr style="border-bottom: 1px solid #f3f4f6; transition: background 0.2s;"
                    onmouseover="this.style.background='#f9fafb'"
                    onmouseout="this.style.background='white'">
                    <td style="padding: 16px; color: #1f2937;" class="local-time" data-utc="{{ transaction.created_at|to_local_time }}">
                        {{ transaction.created_at.strftime('%b %d, %Y %I:%M %p') }} UTC
                    </td>
                    <td style="padding: 16px;">
                        {% if transaction.transaction_type == 'credit' %}
                            <span style="background: #d1fae5; color: #065f46; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; letter-spacing: 0.3px;">
                                CREDIT
                            </span>
                        {% else %}
                            <span style="background: #fee2e2; color: #991b1b; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; letter-spacing: 0.3px;">
                                DEBIT
                            </span>
                        {% endif %}
                    </td>
                    <td style="padding: 16px; color: #6b7280;">
                        {% if transaction.analysis_id and transaction.analysis_id in existing_analyses %}
                            {# Analysis exists - show clickable link #}
                            <a href="{{ url_for('results', analysis_id=transaction.analysis_id) }}" 
                               style="color: #2563eb; text-decoration: none; transition: color 0.2s;"
                               onmouseover="this.style.color='#1e40af'"
                               onmouseout="this.style.color='#2563eb'">
                                {{ transaction.description }} ‚Üí
                            </a>
                        {% elif transaction.analysis_id and transaction.analysis_id not in existing_analyses %}
                            {# Analysis was deleted - show as non-clickable text with tooltip #}
                            {% set deleted_date = deleted_analyses.get(transaction.analysis_id) %}
                            <span style="color: #2563eb; cursor: default;"
                                  {% if deleted_date %}
                                  class="deleted-analysis-tooltip local-time" 
                                  data-utc="{{ deleted_date.isoformat() }}"
                                  title="This analysis was deleted"
                                  {% endif %}>
                                {{ transaction.description }}
                            </span>
                        {% else %}
                            {# No analysis (e.g., credit purchase) #}
                            {{ transaction.description }}
                        {% endif %}
                    </td>
                    <td style="padding: 16px; text-align: right;">
                        {% if transaction.transaction_type == 'credit' and transaction.stripe_amount_cents and transaction.stripe_amount_cents > 0 %}
                            {# Show Stripe payment amount for credit purchases #}
                            <div style="font-weight: 700; font-size: 15px; color: #059669;">
                                +${{ "%.2f"|format(transaction.stripe_amount_cents / 100) }}
                            </div>
                            <div style="font-size: 11px; color: #9ca3af; margin-top: 2px;">
                                (${{ "%.2f"|format(transaction.amount_usd) }} credits)
                            </div>
                        {% elif transaction.amount_usd > 0 %}
                            <span style="color: #059669; font-weight: 700; font-size: 15px;">+${{ "%.2f"|format(transaction.amount_usd) }}</span>
                        {% else %}
                            <span style="color: #dc2626; font-weight: 700; font-size: 15px;">-${{ "%.2f"|format(transaction.amount_usd|abs) }}</span>
                        {% endif %}
                    </td>
                    <td style="padding: 16px; text-align: right; color: #1f2937; font-weight: 700; font-size: 15px;">
                        ${{ "%.2f"|format(balances[loop.index0]) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="font-size: 48px; margin-bottom: 20px;">üìä</div>
        <h2 style="color: #6b7280; margin-bottom: 10px;">No transactions yet</h2>
        <p style="color: #9ca3af; margin-bottom: 30px;">Add funds to start analyzing candidates</p>
        <a href="{{ url_for('payments.buy_credits') }}" class="btn btn-primary">
            Add Funds
        </a>
    </div>
    {% endif %}
    
    <div style="text-align: center; margin-top: 40px;">
        <a href="{{ url_for('dashboard') }}" 
           style="color: #1f77b4; text-decoration: none; font-weight: 500;"
           onmouseover="this.style.textDecoration='underline'"
           onmouseout="this.style.textDecoration='none'">
            ‚Üê Back to Dashboard
        </a>
    </div>
</div>

<script>
// Convert UTC timestamps to user's local timezone
document.addEventListener('DOMContentLoaded', function() {
    // Convert transaction timestamps
    document.querySelectorAll('.local-time:not(.deleted-analysis-tooltip)').forEach(function(elem) {
        const utcTime = elem.getAttribute('data-utc');
        if (utcTime) {
            const date = new Date(utcTime);
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            elem.textContent = date.toLocaleString('en-US', options);
        }
    });
    
    // Convert deleted analysis tooltips
    document.querySelectorAll('.deleted-analysis-tooltip').forEach(function(elem) {
        const utcTime = elem.getAttribute('data-utc');
        if (utcTime) {
            const date = new Date(utcTime);
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            const localTime = date.toLocaleString('en-US', options);
            elem.setAttribute('title', 'This analysis was deleted on ' + localTime);
        }
    });
});
</script>
{% endblock %}
