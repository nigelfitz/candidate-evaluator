{% extends "admin_base.html" %}

{% block title %}Balance Adjustment - Admin Panel{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block extra_styles %}
.balance-check-box {
background: {% if discrepancy == 0 %}#f0fdf4{% else %}#fef2f2{% endif %};
padding: 20px;
border-radius: 8px;
margin-bottom: 30px;
border-left: 4px solid {% if discrepancy == 0 %}#22c55e{% else %}#ef4444{% endif %};
}
.discrepancy-amount {
color: {% if discrepancy == 0 %}#22c55e{% else %}#ef4444{% endif %};
font-weight: 700;
font-size: 18px;
}
{% endblock %}

{% block content %}
<div style="margin-bottom: 30px;">
    <a href="{{ url_for('admin.admin_balance_audit') }}" style="color: #6366f1; text-decoration: none; font-weight: 600;">
        ‚Üê Back to Balance Audit
    </a>
</div>

<h2 style="color: #1f2937; margin: 0 0 8px 0; font-weight: 700;">üîß Balance Adjustment</h2>
<p style="color: #6b7280; margin: 0 0 30px 0;">Create a manual adjustment transaction to reconcile account balance</p>

<!-- User Information -->
<div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
    <h3 style="color: #1f2937; margin: 0 0 16px 0; font-weight: 600;">User Information</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
            <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">Email</div>
            <div style="color: #1f2937; font-weight: 600;">{{ user.email }}</div>
        </div>
        <div>
            <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">User ID</div>
            <div style="color: #1f2937; font-weight: 600;">{{ user.id }}</div>
        </div>
        <div>
            <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">Registration Date</div>
            <div style="color: #1f2937; font-weight: 600;">{{ user.created_at.strftime('%b %d, %Y') }}</div>
        </div>
        <div>
            <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">Current Balance</div>
            <div style="color: #1f2937; font-weight: 600; font-size: 18px;">${{ "%.2f"|format(actual_balance) }}</div>
        </div>
    </div>
</div>

<!-- Balance Integrity Check -->
<div class="balance-check-box">
    <h3 style="color: #1f2937; margin: 0 0 16px 0; font-weight: 600;">Balance Integrity Check</h3>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
        <div>
            <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">Available Balance</div>
            <div style="color: #1f2937; font-weight: 600;">${{ "%.2f"|format(actual_balance) }}</div>
        </div>
        <div>
            <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">Transaction History Balance</div>
            <div style="color: #1f2937; font-weight: 600;">${{ "%.2f"|format(calculated_balance) }}</div>
        </div>
        <div>
            <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">Discrepancy</div>
            <div class="discrepancy-amount">
                {% if discrepancy > 0 %}+{% endif %}${{ "%.2f"|format(discrepancy) }}
            </div>
        </div>
    </div>
    {% if discrepancy != 0 %}
    <div style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 6px; margin-top: 12px;">
        <strong style="color: #dc2626;">‚ö†Ô∏è Balance Mismatch Detected</strong>
        <p style="margin: 8px 0 0 0; color: #6b7280;">
            Suggested adjustment: <strong style="color: #1f2937;">${{ "%.2f"|format(suggested_adjustment) }}</strong> to
            reconcile
        </p>
    </div>
    {% else %}
    <div style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 6px; margin-top: 12px;">
        <strong style="color: #16a34a;">‚úÖ Balance is Correct</strong>
        <p style="margin: 8px 0 0 0; color: #6b7280;">Database balance matches transaction history</p>
    </div>
    {% endif %}
</div>

<!-- Need to Process a Refund? -->
<div
    style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 3px solid #dc2626; padding: 25px; border-radius: 8px; margin-bottom: 30px;">
    <h3 style="color: #7f1d1d; margin: 0 0 15px 0; font-weight: 700; font-size: 20px;">üí∏ Need to Process a Customer
        Refund?</h3>
    <p style="color: #991b1b; margin: 0 0 15px 0; line-height: 1.6;">
        If you need to refund this customer for unused credits or process a Stripe refund, please use the dedicated
        <strong>Refund Page</strong> instead of the adjustment options below.
    </p>
    <div
        style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.9); padding: 15px 20px; border-radius: 8px;">
        <div>
            <div style="color: #1f2937; font-weight: 600; margin-bottom: 4px;">Maximum Refundable: <span
                    style="color: #16a34a; font-size: 18px;">${{ "%.2f"|format(max_refundable) }}</span></div>
            <div style="color: #6b7280; font-size: 13px;">(Excludes promotional/bonus funds)</div>
        </div>
        <a href="{{ url_for('admin.admin_refund', user_id=user.id) }}"
            style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 16px;">
            üí∏ Go to Refund Page ‚Üí
        </a>
    </div>
</div>

<!-- Adjustment Options Explanation -->
<div
    style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 3px solid #3b82f6; padding: 25px; border-radius: 8px; margin-bottom: 30px;">
    <h3 style="color: #1e40af; margin: 0 0 15px 0; font-weight: 700; font-size: 20px;">üìö Understanding Balance
        Adjustments</h3>
    <p style="color: #1e3a8a; margin: 0 0 15px 0; line-height: 1.6;">There are two types of adjustments available,
        depending on the scenario:</p>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
        <div
            style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
            <h4 style="color: #6b21a8; margin: 0 0 12px 0; font-weight: 600;">üîá Type 1: Silent Adjustment</h4>
            <p style="color: #374151; margin: 0 0 12px 0; font-size: 14px; line-height: 1.6;">
                <strong>Changes:</strong> Available Balance only<br>
                <strong>Visible:</strong> No transaction created<br>
                <strong>Use when:</strong> Fixing a discrepancy where Transaction History is correct but Available
                Balance is wrong
            </p>
            <div style="background: #fef3c7; padding: 10px; border-radius: 4px; font-size: 13px; color: #78350f;">
                <strong>Example:</strong> Transaction History shows $40.50, but Available Balance is $33.50. Apply
                +$7.00 silent adjustment.
            </div>
        </div>

        <div
            style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
            <h4 style="color: #065f46; margin: 0 0 12px 0; font-weight: 600;">üìù Type 2: Transaction Adjustment</h4>
            <p style="color: #374151; margin: 0 0 12px 0; font-size: 14px; line-height: 1.6;">
                <strong>Changes:</strong> Both Available Balance AND Transaction History Balance<br>
                <strong>Visible:</strong> Shows as transaction in user's history<br>
                <strong>Use when:</strong> Adding/removing actual funds (refund, bonus, correction of a real payment)
            </p>
            <div style="background: #fef3c7; padding: 10px; border-radius: 4px; font-size: 13px; color: #78350f;">
                <strong>Example:</strong> Need to refund customer $25. Apply -$25.00 transaction adjustment (affects
                both balances).
            </div>
        </div>
    </div>

    <div
        style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #f59e0b;">
        <strong style="color: #92400e;">üí° Pro Tip - Complex Scenarios:</strong>
        <p style="color: #374151; margin: 8px 0 0 0; font-size: 14px; line-height: 1.6;">
            For complex scenarios, you may need to use BOTH adjustment types. <strong>Example:</strong> If balances are
            misaligned but you want the correction to show in Transaction History (not be silent), first apply a
            <strong>Transaction Adjustment</strong> for the amount needed (e.g., +$7.00), then apply a <strong>Silent
                Adjustment</strong> for the opposite amount (e.g., -$7.00). This changes Transaction History Balance
            while keeping Available Balance unchanged.
        </p>
    </div>
</div>

<!-- Type 1: Silent Adjustment Form -->
<form method="POST" action="{{ url_for('admin.admin_balance_adjustment', user_id=user.id) }}"
    style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 30px; border-left: 4px solid #8b5cf6;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="adjustment_type" value="silent">
    <h3 style="color: #6b21a8; margin: 0 0 12px 0; font-weight: 600; font-size: 20px;">üîá Type 1: Silent Adjustment</h3>
    <p style="color: #6b7280; margin: 0 0 20px 0; font-size: 14px;">Adjusts Available Balance only. No transaction
        created. Use for fixing discrepancies.</p>

    <div style="margin-bottom: 20px;">
        <label style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">
            Adjustment Amount (USD)
        </label>
        <input type="number" name="adjustment_amount" step="0.01" value="{% if suggested_adjustment %}{{ "
            %.2f"|format(suggested_adjustment) }}{% endif %}"
            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px;"
            placeholder="Enter amount (positive to add, negative to subtract)" required>
        <small style="color: #6b7280; display: block; margin-top: 6px;">
            <strong>Suggested:</strong> ${{ "%.2f"|format(suggested_adjustment) }} (to align Available Balance with
            Transaction History Balance)
        </small>
    </div>

    <div style="margin-bottom: 20px;">
        <label style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">
            Reason for Adjustment
        </label>
        <textarea name="reason" rows="2"
            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px;"
            placeholder="Enter reason (e.g., 'Fixing discrepancy - Transaction History is correct')"
            required></textarea>
    </div>

    <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button type="submit"
            style="padding: 12px 24px; background: linear-gradient(135deg, #8b5cf6 0%, #6b21a8 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
            üîá Apply Silent Adjustment
        </button>
    </div>
</form>

<!-- Type 2: Transaction Adjustment Form -->
<form method="POST" action="{{ url_for('admin.admin_balance_adjustment', user_id=user.id) }}"
    style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #10b981;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="adjustment_type" value="transaction">
    <h3 style="color: #065f46; margin: 0 0 12px 0; font-weight: 600; font-size: 20px;">üìù Type 2: Transaction Adjustment
    </h3>
    <p style="color: #6b7280; margin: 0 0 20px 0; font-size: 14px;">Creates a visible transaction in user's history.
        Affects both Available Balance and Transaction History Balance.</p>

    <div style="margin-bottom: 20px;">
        <label style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">
            Transaction Amount (USD)
        </label>
        <input type="number" name="adjustment_amount" step="0.01"
            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px;"
            placeholder="Enter amount (positive to add, negative to subtract)" required>
        <small style="color: #6b7280; display: block; margin-top: 6px;">
            Use positive for credits (adding funds), negative for debits (removing funds/refunds)
        </small>
    </div>

    <div style="margin-bottom: 20px;">
        <label style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">
            Transaction Description (Visible to User)
        </label>
        <textarea name="reason" rows="2"
            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px;"
            placeholder="Enter description (e.g., 'Refund - Unused Credits' or 'Bonus Credits - Holiday Promotion')"
            required></textarea>
        <small style="color: #6b7280; display: block; margin-top: 6px;">
            This description will be visible to the user in their transaction history
        </small>
    </div>

    <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <a href="{{ url_for('admin.admin_balance_audit') }}"
            style="padding: 12px 24px; background: #e5e7eb; color: #374151; border-radius: 6px; text-decoration: none; font-weight: 600; display: inline-block;">
            Cancel
        </a>
        <button type="submit"
            style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #065f46 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
            üìù Create Transaction Adjustment
        </button>
    </div>
</form>
{% endblock %}
