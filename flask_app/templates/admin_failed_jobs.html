{% extends "admin_base.html" %}

{% block title %}Failed Jobs - Admin{% endblock %}

{% block extra_styles %}
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.stat-value { font-size: 32px; font-weight: bold; color: #dc3545; }
.stat-label { color: #6c757d; font-size: 14px; margin-top: 5px; }
.jobs-table { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }
.error-cell { max-width: 400px; overflow: hidden; text-overflow: ellipsis; font-family: 'Courier New', monospace; font-size: 12px; }
.error-full { display: none; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 11px; background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px; max-height: 400px; overflow-y: auto; }
.expand-btn { cursor: pointer; color: #0d6efd; text-decoration: underline; font-size: 12px; }
{% endblock %}

{% block content %}
<div style="padding: 30px; border-radius: 12px; margin-bottom: 30px;">
    <h1 style="margin: 0; color: #1e293b;">‚ùå Failed Job Analyses</h1>
    <p style="color: #64748b; margin: 10px 0 0 0;">Monitor and diagnose analysis failures</p>
</div>

<!-- Summary Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ failed_jobs|length }}</div>
        <div class="stat-label">TOTAL FAILURES</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ failed_last_24h }}</div>
        <div class="stat-label">LAST 24 HOURS</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ affected_users|length }}</div>
        <div class="stat-label">AFFECTED USERS</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ common_errors|length }}</div>
        <div class="stat-label">ERROR TYPES</div>
    </div>
</div>

<!-- Common Error Patterns -->
{% if common_errors %}
<div class="jobs-table" style="margin-bottom: 30px;">
    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
        <h3 style="margin: 0; color: #1e293b;">üîç Common Error Patterns</h3>
    </div>
    <table class="table table-hover mb-0">
        <thead>
            <tr>
                <th>Error Type</th>
                <th>Count</th>
                <th>First Example</th>
            </tr>
        </thead>
        <tbody>
            {% for error_type, count, example in common_errors %}
            <tr>
                <td><code>{{ error_type }}</code></td>
                <td><span class="badge bg-danger">{{ count }}</span></td>
                <td class="error-cell">{{ example[:100] }}{% if example|length > 100 %}...{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Failed Jobs Table -->
<div class="jobs-table">
    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
        <h3 style="margin: 0; color: #1e293b;">üìã All Failed Jobs (Last 50)</h3>
    </div>
    
    {% if failed_jobs %}
    <table class="table table-hover mb-0">
        <thead>
            <tr>
                <th>Job ID</th>
                <th>User</th>
                <th>Job Title</th>
                <th>Progress</th>
                <th>Failed At</th>
                <th>Error</th>
            </tr>
        </thead>
        <tbody>
            {% for job in failed_jobs %}
            <tr>
                <td><strong>Job #{{ "%04d"|format(job.id) }}</strong></td>
                <td>{{ job.user.email }}</td>
                <td>{{ job.job_title or 'Untitled' }}</td>
                <td>{{ job.resumes_processed or 0 }}/{{ job.num_candidates }} candidates</td>
                <td>{{ job.failed_at.strftime('%Y-%m-%d %H:%M') if job.failed_at else 'Unknown' }}</td>
                <td>
                    <div class="error-cell">
                        {{ job.error_message.split('\n')[0][:100] if job.error_message else 'No error message' }}
                    </div>
                    {% if job.error_message %}
                    <span class="expand-btn" onclick="toggleError({{ job.id }})">Show full error ‚Üì</span>
                    <div id="error-{{ job.id }}" class="error-full">{{ job.error_message }}</div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="padding: 60px 20px; text-align: center; color: #64748b;">
        <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
        <h3>No Failed Jobs</h3>
        <p>All analyses are completing successfully!</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function toggleError(jobId) {
    const errorDiv = document.getElementById('error-' + jobId);
    if (errorDiv.style.display === 'none' || errorDiv.style.display === '') {
        errorDiv.style.display = 'block';
        event.target.textContent = 'Hide full error ‚Üë';
    } else {
        errorDiv.style.display = 'none';
        event.target.textContent = 'Show full error ‚Üì';
    }
}
</script>
{% endblock %}
