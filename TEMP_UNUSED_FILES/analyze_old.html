{% extends "base.html" %}

{% block title %}Analyze Candidates - Candidate Evaluator{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 40px 20px;">
    <h1 style="color: #1f2937; margin-bottom: 10px;">Analyze Candidates</h1>
    <p style="color: #6b7280; margin-bottom: 30px;">Upload a job description and candidate resumes to start analysis</p>
    
    <!-- Credit Balance -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                padding: 20px; 
                border-radius: 12px; 
                margin-bottom: 30px;
                color: white;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Available Balance</div>
        <div style="font-size: 32px; font-weight: bold;">${{ "%.2f"|format(current_user.balance_usd) }}</div>
        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
            Need more? <a href="{{ url_for('payments.buy_credits') }}" style="color: white; text-decoration: underline;">Add Funds</a>
        </div>
    </div>

    <form method="POST" action="{{ url_for('analyze') }}" enctype="multipart/form-data" id="analyzeForm">
        <!-- Job Description Upload -->
        <div style="background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 style="color: #1f2937; margin-bottom: 20px; font-size: 20px;">üìÑ Job Description</h2>
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 8px;">
                    Upload Job Description (PDF, DOCX, TXT)
                </label>
                <input type="file" 
                       name="job_description" 
                       id="jdFile"
                       accept=".pdf,.docx,.doc,.txt"
                       required
                       style="display: block; 
                              width: 100%; 
                              padding: 12px; 
                              border: 2px dashed #d1d5db; 
                              border-radius: 8px; 
                              background: #f9fafb;
                              cursor: pointer;">
                <div id="jdFileName" style="margin-top: 8px; color: #6b7280; font-size: 14px;"></div>
            </div>
        </div>

        <!-- Candidate Resumes Upload -->
        <div style="background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 style="color: #1f2937; margin-bottom: 20px; font-size: 20px;">üë• Candidate Resumes</h2>
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 8px;">
                    Upload Candidate Resumes (PDF, DOCX, TXT - Multiple files allowed)
                </label>
                <input type="file" 
                       name="resumes" 
                       id="resumeFiles"
                       accept=".pdf,.docx,.doc,.txt"
                       multiple
                       required
                       style="display: block; 
                              width: 100%; 
                              padding: 12px; 
                              border: 2px dashed #d1d5db; 
                              border-radius: 8px; 
                              background: #f9fafb;
                              cursor: pointer;">
                <div id="resumeFileNames" style="margin-top: 8px; color: #6b7280; font-size: 14px;"></div>
            </div>
        </div>

        <!-- Cost Estimate -->
        <div id="costEstimate" style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none;">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <span style="font-size: 24px; margin-right: 10px;">üí∞</span>
                <div>
                    <div style="font-weight: 600; color: #92400e;">Estimated Cost</div>
                    <div id="costAmount" style="font-size: 24px; font-weight: bold; color: #78350f;"></div>
                </div>
            </div>
            <div style="font-size: 14px; color: #92400e;">
                <div id="costBreakdown"></div>
            </div>
        </div>

        <!-- Analysis Options -->
        <div style="background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 style="color: #1f2937; margin-bottom: 20px; font-size: 20px;">‚öôÔ∏è Analysis Options</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" 
                           name="extract_criteria" 
                           id="extractCriteria"
                           checked
                           style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                    <span style="color: #374151; font-weight: 500;">
                        Automatically extract criteria from job description using AI
                    </span>
                </label>
                <div style="margin-left: 28px; margin-top: 5px; color: #6b7280; font-size: 14px;">
                    GPT will analyze the JD and create evaluation criteria (recommended)
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 10px;">
                    ü§ñ AI-Powered Candidate Insights
                </label>
                <div style="margin-left: 0px; margin-bottom: 15px;">
                    <select name="insights_mode" id="insightsMode" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; cursor: pointer;">
                        <option value="top3" selected>Top 3 candidates (included in base price)</option>
                        <option value="top5">Top 5 candidates (+$2)</option>
                        <option value="top10">Top 10 candidates (+$7)</option>
                        <option value="all">All candidates</option>
                        <option value="none">No AI insights (scoring only)</option>
                    </select>
                </div>
                <div style="margin-left: 0px; color: #6b7280; font-size: 14px;">
                    AI insights include detailed strengths, gaps, risks, and suitability analysis. 
                    Base price ($4) includes top 3 candidates. Extra insights cost $1 each.
                </div>
            </div>

            <div>
                <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 8px;">
                    Number of criteria to extract (6-30)
                </label>
                <input type="number" 
                       name="max_criteria" 
                       id="maxCriteria"
                       value="20"
                       min="6"
                       max="30"
                       style="width: 120px; 
                              padding: 8px 12px; 
                              border: 1px solid #d1d5db; 
                              border-radius: 6px; 
                              font-size: 16px;">
                <div style="margin-top: 5px; color: #6b7280; font-size: 14px;">
                    More criteria = more comprehensive analysis (and higher cost)
                </div>
            </div>
        </div>

        <!-- Analyze Button -->
        <button type="submit" 
                id="analyzeBtn"
                style="width: 100%; 
                       padding: 16px; 
                       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                       color: white; 
                       border: none; 
                       border-radius: 8px; 
                       font-size: 18px; 
                       font-weight: 600; 
                       cursor: pointer; 
                       box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                       transition: all 0.3s ease;"
                onmouseover="this.style.opacity='0.9'; this.style.transform='translateY(-2px)'"
                onmouseout="this.style.opacity='1'; this.style.transform='translateY(0)'">
            üöÄ Start Analysis
        </button>
    </form>

    <!-- Help Section -->
    <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 20px; border-radius: 8px; margin-top: 30px;">
        <h3 style="color: #1e40af; margin-bottom: 10px; font-size: 16px;">üìö How it works</h3>
        <ol style="margin: 0; padding-left: 20px; color: #1e40af; line-height: 1.8;">
            <li>Upload your job description (JD) file</li>
            <li>Upload candidate resume files (you can select multiple)</li>
            <li>AI extracts evaluation criteria from the JD</li>
            <li>Each candidate is scored against all criteria using semantic similarity</li>
            <li>View ranked results with detailed insights and evidence</li>
        </ol>
        <div style="margin-top: 15px; color: #1e40af; font-size: 14px;">
            <strong>Supported formats:</strong> PDF, DOCX, DOC, TXT<br>
            <strong>Cost:</strong> $4 per analysis (includes all candidates scored + top 3 AI insights + reports). Extra AI insights: $1 each
        </div>
    </div>
</div>

<script>
// Display selected JD filename
document.getElementById('jdFile').addEventListener('change', function(e) {
    const fileName = e.target.files[0]?.name;
    document.getElementById('jdFileName').textContent = fileName ? `üìÑ ${fileName}` : '';
    updateCostEstimate();
});

// Display selected resume filenames
document.getElementById('resumeFiles').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    const fileList = files.map(f => `üìÑ ${f.name}`).join('<br>');
    document.getElementById('resumeFileNames').innerHTML = fileList || '';
    document.getElementById('resumeFileNames').style.marginTop = files.length > 0 ? '12px' : '8px';
    updateCostEstimate();
});

// Update cost estimate
function updateCostEstimate() {
    const jdFile = document.getElementById('jdFile').files[0];
    const resumeFiles = document.getElementById('resumeFiles').files;
    const insightsMode = document.getElementById('insightsMode').value;
    
    if (jdFile && resumeFiles.length > 0) {
        const numCandidates = resumeFiles.length;
        
        // Base price: $4.00 (JD extraction + scoring all candidates + top 3 insights + reports)
        let totalCost = 4.00;
        
        // Calculate extra insights beyond top 3
        let extraInsights = 0;
        let insightCandidates = 3; // Default for top3
        
        if (insightsMode === 'top5') {
            insightCandidates = Math.min(5, numCandidates);
            extraInsights = Math.max(0, insightCandidates - 3);
        } else if (insightsMode === 'top10') {
            insightCandidates = Math.min(10, numCandidates);
            extraInsights = Math.max(0, insightCandidates - 3);
        } else if (insightsMode === 'all') {
            insightCandidates = numCandidates;
            extraInsights = Math.max(0, insightCandidates - 3);
        } else if (insightsMode === 'none') {
            insightCandidates = 0;
            extraInsights = 0;
        }
        // 'top3' already covered in base price
        
        // Add cost for extra insights
        const extraCost = extraInsights * 1.00;
        totalCost += extraCost;
        
        document.getElementById('costEstimate').style.display = 'block';
        document.getElementById('costAmount').textContent = `$${totalCost.toFixed(2)}`;
        
        // Build breakdown
        let breakdown = `Base analysis: $4.00 (JD extraction + scoring ${numCandidates} candidate${numCandidates > 1 ? 's' : ''} + top 3 AI insights + reports)`;
        
        if (extraInsights > 0) {
            breakdown += `<br>Extra AI insights: +$${extraCost.toFixed(2)} (${extraInsights} additional candidate${extraInsights > 1 ? 's' : ''} √ó $1.00)`;
        } else if (insightsMode === 'none') {
            breakdown += `<br>No AI insights: $0.00 (scoring only)`;
        }
        
        breakdown += `<br><strong>Total: $${totalCost.toFixed(2)}</strong>`;
        
        document.getElementById('costBreakdown').innerHTML = breakdown;
        
        // Check if user has enough balance
        const availableBalance = {{ current_user.balance_usd }};
        if (totalCost > availableBalance) {
            document.getElementById('costEstimate').style.background = '#fee2e2';
            document.getElementById('costEstimate').style.borderColor = '#ef4444';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').style.opacity = '0.5';
            document.getElementById('analyzeBtn').style.cursor = 'not-allowed';
            document.getElementById('costBreakdown').innerHTML += `<br><strong style="color: #991b1b;">‚ö†Ô∏è Insufficient funds! You need $${(totalCost - availableBalance).toFixed(2)} more.</strong>`;
        } else {
            document.getElementById('costEstimate').style.background = '#fef3c7';
            document.getElementById('costEstimate').style.borderColor = '#f59e0b';
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('analyzeBtn').style.opacity = '1';
            document.getElementById('analyzeBtn').style.cursor = 'pointer';
        }
    } else {
        document.getElementById('costEstimate').style.display = 'none';
    }
}

// Update cost when options change
document.getElementById('insightsMode').addEventListener('change', updateCostEstimate);

// Show loading state on submit
document.getElementById('analyzeForm').addEventListener('submit', function(e) {
    const btn = document.getElementById('analyzeBtn');
    btn.textContent = '‚è≥ Analyzing... This may take a few minutes';
    btn.disabled = true;
    btn.style.cursor = 'wait';
});
</script>
{% endblock %}
